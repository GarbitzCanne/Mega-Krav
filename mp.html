<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>MEGA KRAV: MULTIPLAYER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --neon: #39ff14; --danger: #ff0033; --warn: #ffcc00; --bg: #050a05; }
        body { background: #000; color: var(--neon); font-family: 'VT323', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }
        body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04)); z-index: 100; pointer-events: none; background-size: 100% 3px, 3px 100%; }
        #app { width: 90%; max-width: 420px; background: var(--bg); padding: 15px; border: 4px solid var(--neon); box-shadow: 0 0 20px var(--neon); position: relative; z-index: 5; text-align: center; }
        #screen { border: 2px solid #113311; background: #000; padding: 10px; min-height: 280px; font-size: 22px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; white-space: pre-wrap; }
        #timeBarBox { width: 100%; height: 14px; background: #111; border: 2px solid var(--neon); margin-bottom: 10px; }
        #timeBar { height: 100%; width: 100%; background: var(--neon); transition: width 0.1s linear; }
        .btn { display: block; width: 100%; margin: 5px 0; padding: 10px; background: #0a1a0a; color: var(--neon); border: 2px solid var(--neon); font-family: 'VT323'; font-size: 20px; cursor: pointer; }
        .btn:hover { background: var(--neon); color: #000; }
        .shame-text { font-size: 45px; text-shadow: 0 0 15px red; animation: glitch 0.1s infinite; }
        @keyframes glitch { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
        .amos-img { width: 100px; height: 100px; border: 2px solid var(--danger); image-rendering: pixelated; margin-bottom: 10px; }
        .flash-yellow { background: rgba(255, 204, 0, 0.4) !important; }
        .balbalot-shake { animation: shake-heavy 0.2s infinite; border-color: var(--danger) !important; }
        @keyframes shake-heavy { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-2px, -1px); } 100% { transform: translate(-1px, 2px); } }
        input { background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 5px; font-family: 'VT323'; font-size: 18px; width: 80%; margin-bottom: 10px; }
    </style>
</head>
<body>
<div id="app">
    <div id="status" style="font-size:12px; margin-bottom: 5px;">KRAV_NET // DISCONNECTED</div>
    <div id="timeBarBox"><div id="timeBar"></div></div>
    <div id="screen"></div>
    <div id="buttons"></div>
</div>

<script>
const $ = id => document.getElementById(id);
let peer, conn;
let isHost = false, myReady = false, peerReady = false, rematchRequest = false;
let stage = 0, round = 1, balbalot = false, barTimer, barWidth = 100;
let pChoice = null, oChoice = null, suddenActive = false;

const MOVES = { NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"], BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"] };

// --- CONNECTION LOGIC ---
function initMenu() {
    $("screen").innerHTML = "MEGA KRAV MP\nSELECT MODE";
    btns([
        {t: "HOST GAME", fn: hostGame},
        {t: "JOIN GAME", fn: joinMenu},
        {t: "BACK TO MENU", fn: () => window.location.href='index.html'}
    ]);
}

function hostGame() {
    isHost = true;
    peer = new Peer();
    peer.on('open', id => {
        $("screen").innerHTML = `ID שלך:\n<b style="color:white; font-size:30px">${id}</b>\n\nשלח ליריב...`;
        $("status").innerText = "WAITING FOR CONNECTION...";
    });
    peer.on('connection', c => setupConn(c));
}

function joinMenu() {
    $("screen").innerHTML = `הכנס ID של המארח:`;
    const input = document.createElement("input");
    input.id = "peerIdInput";
    $("screen").appendChild(input);
    btns([{t: "CONNECT", fn: () => {
        const id = $("peerIdInput").value;
        peer = new Peer();
        setupConn(peer.connect(id));
    }}]);
}

function setupConn(c) {
    conn = c;
    conn.on('open', () => {
        $("status").innerText = "CONNECTED";
        showReadyScreen();
    });
    conn.on('data', data => handleData(data));
    conn.on('close', () => onOpponentLeft());
}

// --- DATA HANDLING ---
function handleData(d) {
    if (d.type === 'READY') { peerReady = true; checkStart(); }
    if (d.type === 'START_GAME') { startGame(); }
    if (d.type === 'MOVE') { oChoice = d.move; checkResolve(); }
    if (d.type === 'NEXT_STAGE') { stage = d.stage; next(); }
    if (d.type === 'SUDDEN') { sudden(); }
    if (d.type === 'REMATCH') { rematchRequest = true; checkRematch(); }
    if (d.type === 'TEKO') { tekoFlash(); }
}

function send(type, data = {}) { if(conn) conn.send({type, ...data}); }

// --- GAME FLOW ---
function showReadyScreen() {
    $("screen").innerHTML = "CHALLENGER FOUND!\nREADY?";
    btns([{t: "I'M READY", fn: () => {
        myReady = true;
        send('READY');
        $("screen").innerHTML = "WAITING FOR OPPONENT...";
        $("buttons").innerHTML = "";
        checkStart();
    }}]);
}

function checkStart() {
    if (myReady && peerReady) {
        if (isHost) {
            send('START_GAME');
            startGame();
        }
    }
}

function startGame() {
    stage = 0; round = 1; balbalot = false;
    $("app").classList.remove("balbalot-shake");
    next();
}

function next() {
    const speed = 1 + (round - 1) * 0.85;
    if (stage === 0) {
        const text = balbalot ? "מגה חרב" : "מגה קרב";
        $("screen").innerHTML = `STAGE 1\n${text}`;
        btns([{t:text, ok:true}, {t:"מגה גרב", ok:false}]);
        startBar(80 / speed); stage = 1;
    } else if (stage === 1) {
        const text = balbalot ? "סופר חרב" : "סופר קרב";
        $("screen").innerHTML = `STAGE 2\n${text}`;
        btns([{t:text, ok:true}, {t:"סופר קרפ", ok:false}]);
        startBar(80 / speed); stage = 2;
    } else if (stage === 2) {
        const text = balbalot ? "מגה מגה מגה חרב" : "מגה מגה מגה קרב";
        $("screen").innerHTML = `CHANT!\n${text}`;
        btns([{t:text, ok:true}, {t:"מנה מנה מנה", ok:false}]);
        startBar(60 / speed); stage = 3;
    } else if (stage === 3) {
        $("screen").innerHTML = `ROUND ${round}\nGO!!`;
        btns((balbalot ? MOVES.BAL : MOVES.NORMAL).map(m => ({t:m, ok:true, move: true})));
        startBar(120 / speed);
    }
}

function startBar(interval) {
    clearInterval(barTimer); barWidth = 100;
    barTimer = setInterval(() => {
        barWidth -= 2; $("timeBar").style.width = barWidth + "%";
        if (barWidth <= 0) triggerShame("קורבן!", "איטי מדי!");
    }, interval);
}

function btns(arr) {
    $("buttons").innerHTML = arr.map(b => `<button class='btn' onclick="press('${b.t}', ${b.ok}, ${!!b.fn}, ${!!b.move})">${b.t}</button>`).join("");
    if (arr[0].fn) window.lastFns = arr;
}

function press(t, ok, isFn, isMove) {
    if (isFn) { window.lastFns.find(f => f.t === t).fn(); return; }
    if (!ok) { send('MOVE', {move: 'FAIL'}); triggerShame("קורבן!", "קלט שגוי!"); return; }
    if (stage === 100) { suddenActive = false; victory(); return; }
    if (isMove) {
        clearInterval(barTimer);
        pChoice = t;
        send('MOVE', {move: t});
        $("screen").innerHTML = "WAITING FOR OPPONENT...";
        $("buttons").innerHTML = "";
        checkResolve();
        return;
    }
    if (isHost) { stage++; send('NEXT_STAGE', {stage}); next(); }
}

function checkResolve() {
    if (pChoice && oChoice) {
        if (pChoice === 'FAIL' || oChoice === 'FAIL') {
            if (pChoice === 'FAIL' && oChoice === 'FAIL') triggerShame("קורבן!", "שניכם נכשלתם");
            else if (pChoice === 'FAIL') triggerShame("קורבן!", "נכשלת ברצף!");
            else victory();
            return;
        }
        const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
        const wins = [[list[0], list[3]], [list[1], list[0]], [list[2], list[1]], [list[3], list[2]]];
        const pW = wins.some(p => p[0] === pChoice && p[1] === oChoice);
        const cW = wins.some(p => p[0] === oChoice && p[1] === pChoice);

        if (pW) victory();
        else if (cW) triggerShame("מפסידן!", "הובסת!");
        else {
            pChoice = oChoice = null;
            round++;
            if (round === 3) { balbalot = true; $("app").classList.add("balbalot-shake"); }
            if (round >= 4) { if(isHost) send('SUDDEN'); sudden(); }
            else { if(isHost) send('TEKO'); tekoFlash(); }
        }
    }
}

function tekoFlash() {
    $("screen").innerHTML = "TEKO TEKO!";
    $("screen").classList.add("flash-yellow");
    setTimeout(() => { $("screen").classList.remove("flash-yellow"); if(isHost) next(); }, 800);
}

function sudden() {
    stage = 100;
    $("screen").innerHTML = `<img src="https://img.mako.co.il/2016/05/26/petiber_i.jpg" class="amos-img">\nעמוס פטיבר!`;
    suddenActive = true;
    setTimeout(() => { if (suddenActive) triggerShame("מפסידן!", "עמוס שתה אותך!"); }, 1300);
    btns([{t:"פטיבר עמוס", ok:true}]);
}

function triggerShame(title, msg) {
    clearInterval(barTimer);
    $("screen").innerHTML = `<div class="shame-text">${title}</div>${msg}`;
    showEndMenu();
}

function victory() {
    clearInterval(barTimer);
    $("screen").innerHTML = `<div class="shame-text" style="color:var(--neon)">נצחון!</div>`;
    showEndMenu();
}

function showEndMenu() {
    pChoice = oChoice = null;
    btns([
        {t: "REMATCH", fn: () => {
            myReady = true; send('REMATCH');
            $("screen").innerHTML = "WAITING FOR OPPONENT...";
            checkRematch();
        }},
        {t: "EXIT", fn: () => window.location.href='index.html'}
    ]);
}

function checkRematch() {
    if (myReady && rematchRequest) {
        myReady = peerReady = rematchRequest = false;
        startGame();
    }
}

function onOpponentLeft() {
    clearInterval(barTimer);
    $("screen").innerHTML = "OPPONENT LEFT.\nBACK TO MENU...";
    setTimeout(() => window.location.href='index.html', 3000);
}

initMenu();
</script>
</body>
</html>
