<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV: MULTIPLAYER</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

:root {
  --neon: #39ff14;
  --neon-p2: #ff33ff;
  --bg: #050a05;
  --danger: #ff0033;
  --warn: #ffcc00;
}

body {
  background: #000;
  color: var(--neon);
  font-family: 'VT323', monospace;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  overflow-x: hidden;
  text-transform: uppercase;
  padding: 20px;
}

/* CRT SCANLINE OVERLAY */
body::before {
  content: "";
  display: block;
  position: absolute;
  top: 0; left: 0; bottom: 0; right: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
              linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
  z-index: 100;
  background-size: 100% 3px, 3px 100%;
  pointer-events: none;
}

#container {
  width: 100%;
  max-width: 900px;
  position: relative;
  z-index: 5;
}

.game-area {
  display: flex;
  gap: 20px;
  justify-content: center;
  flex-wrap: wrap;
}

.player-box {
  width: 100%;
  max-width: 420px;
  background: var(--bg);
  padding: 15px;
  border: 4px solid var(--neon);
  box-shadow: 0 0 20px var(--neon);
  text-align: center;
  transition: transform 0.1s;
}

.player-box.p2 {
  box-shadow: 0 0 20px var(--neon-p2);
  border-color: var(--neon-p2);
}

.player-box.p2 .player-name {
  color: var(--neon-p2);
}

#lobby {
  width: 100%;
  max-width: 500px;
  background: var(--bg);
  padding: 30px;
  border: 4px solid var(--neon);
  box-shadow: 0 0 20px var(--neon);
  text-align: center;
  margin: 0 auto;
}

.player-name {
  color: var(--neon);
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 5px;
}

/* CONNECTION STATUS */
#status {
  font-size: 14px;
  margin-bottom: 10px;
  padding: 8px;
  border: 2px solid #333;
  background: #000;
}

#status.connected {
  border-color: var(--neon);
  color: var(--neon);
}

#status.disconnected {
  border-color: var(--danger);
  color: var(--danger);
}

#status.waiting {
  border-color: var(--warn);
  color: var(--warn);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

#timeBarBox {
  width: 100%;
  height: 14px;
  background: #111;
  border: 2px solid var(--neon);
  margin-bottom: 10px;
}

#timeBar {
  height: 100%;
  width: 100%;
  background: var(--neon);
  box-shadow: 0 0 10px var(--neon);
  transition: width 0.05s linear;
}

.screen {
  border: 2px solid #113311;
  background: #000;
  padding: 10px;
  min-height: 280px;
  font-size: 24px;
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  white-space: pre-wrap;
  transition: background 0.2s;
}

.amos-img {
  width: 120px;
  height: 120px;
  border: 3px solid var(--danger);
  filter: contrast(1.5) grayscale(0.5);
  image-rendering: pixelated;
  margin-bottom: 10px;
}

.btn {
  display: block;
  width: 100%;
  margin: 5px 0;
  padding: 10px;
  background: #0a1a0a;
  color: var(--neon);
  border: 2px solid var(--neon);
  font-family: 'VT323';
  font-size: 22px;
  cursor: pointer;
  transition: all 0.05s;
}

.btn:hover {
  background: var(--neon);
  color: #000;
}

.btn.big {
  font-size: 26px;
  padding: 15px;
}

input {
  width: 90%;
  padding: 15px;
  font-size: 20px;
  background: #000;
  border: 2px solid var(--neon);
  color: var(--neon);
  font-family: 'VT323';
  margin: 10px 0;
  text-transform: uppercase;
}

/* ANIMATIONS */
.shame-text {
  font-size: 50px;
  text-shadow: 0 0 15px red;
  animation: glitch 0.1s infinite;
}

@keyframes glitch {
  0% { transform: translate(2px, 2px); }
  50% { transform: translate(-2px, -2px); }
  100% { transform: translate(2px, -2px); }
}

.balbalot-shake {
  animation: shake-heavy 0.2s infinite;
  border-color: var(--danger) !important;
}

@keyframes shake-heavy {
  0% { transform: translate(1px, 1px) rotate(0deg); }
  20% { transform: translate(-2px, -1px) rotate(1deg); }
  40% { transform: translate(2px, 1px) rotate(-1deg); }
  100% { transform: translate(-1px, 2px) rotate(0deg); }
}

.flash-yellow {
  background: rgba(255, 204, 0, 0.4) !important;
}

#roomCode {
  font-size: 32px;
  color: #ffff33;
  margin: 20px 0;
  letter-spacing: 3px;
}
</style>
</head>

<body>
<div id="container">
  <div id="lobby">
    <h1 style="font-size:32px; margin-bottom:20px;">MEGA KRAV<br>MULTIPLAYER</h1>
    <div id="status" class="disconnected">KRAV_NET // DISCONNECTED</div>
    
    <div id="menu">
      <button class="btn big" onclick="createGame()">HOST GAME</button>
      <button class="btn big" onclick="showJoin()">JOIN GAME</button>
      <button class="btn big" onclick="backToMenu()">BACK TO MENU</button>
    </div>

    <div id="join-screen" style="display:none;">
      <input type="text" id="peerIdInput" placeholder="ENTER PEER ID" />
      <button class="btn" onclick="joinGame()">CONNECT</button>
      <button class="btn" onclick="showMenu()">BACK</button>
    </div>

    <div id="waiting-screen" style="display:none;">
      <div style="color:#ffcc00; font-size:22px;">WAITING FOR OPPONENT...</div>
      <div style="font-size:18px; margin-top:10px;">YOUR PEER ID:</div>
      <div id="roomCode"></div>
      <div style="font-size:16px;">Share this ID with your friend</div>
      <button class="btn" onclick="cancelHost()">CANCEL</button>
    </div>

    <div id="ready-screen" style="display:none;">
      <div style="font-size:28px; margin:20px 0;">CHALLENGER FOUND!</div>
      <div style="font-size:20px; margin-bottom:20px;">READY TO FIGHT?</div>
      <button class="btn big" onclick="setReady()">I'M READY</button>
    </div>
  </div>

  <div id="game-area" class="game-area" style="display:none;">
    <div class="player-box" id="myBox">
      <div class="player-name">YOU (P1)</div>
      <div id="myStatus" style="font-size:12px; margin-bottom:5px;">KRAV_OS // SPD: 1.0x</div>
      <div id="timeBarBox"><div id="timeBar"></div></div>
      <div class="screen" id="myScreen"></div>
      <div id="myButtons"></div>
    </div>

    <div class="player-box p2">
      <div class="player-name">OPPONENT (P2)</div>
      <div id="oppStatus" style="font-size:12px; margin-bottom:5px;">KRAV_OS // SPD: 1.0x</div>
      <div class="screen" id="oppScreen">WAITING...</div>
    </div>
  </div>
</div>

<script>
// ===== AUDIO ENGINE =====
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let musicStarted = false;

function playMusic() {
    if (musicStarted) return;
    musicStarted = true;
    const sequence = [110, 0, 110, 110, 82, 0, 98, 123];
    let i = 0;
    setInterval(() => {
        if (sequence[i] > 0) {
            const osc = ctx.createOscillator(), g = ctx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.value = sequence[i];
            g.gain.setValueAtTime(0.08, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
            osc.connect(g);
            g.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.25);
        }
        i = (i + 1) % sequence.length;
    }, 180);
}

// ===== PEERJS SETUP =====
let peer = null;
let conn = null;
let isHost = false;
let myPeerId = null;
let myReady = false;
let peerReady = false;
let rematchRequest = false;

// ===== GAME STATE =====
let stage=0, round=1, balbalot=false, lock=false;
let barTimer=null, barWidth=100;
let pChoice=null, oChoice=null;
let suddenActive=false;

// ===== TABLES =====
const MOVES = {
    NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"],
    BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"]
};

const DECOYS = {
    "מגה קרב": ["מגע קרב", "מגה גרב", "מגה קרבה"],
    "סופר קרב": ["סופר כרב", "סופר קרפ", "סופ קרב"],
    "מגה מגה מגה קרב": ["מגה מגה קרב", "מנה מנה מנה קרב"],
    "מגה חרב": ["מגע חרב", "מגה גרב"],
    "סופר חרב": ["סופר כרב", "סופר חרפ"],
    "מגה מגה מגה חרב": ["מגה מגה חרב", "מנה מנה מנה חרב"],
    "תיקו תיקו": ["טיקו תיקו", "תיקו תיק", "טיקו טיקו"],
    "פטיבר עמוס": ["פתיבר אמוס", "פטיבר עמוש", "פתיבר עמוס"]
};

function getDecoys(word) {
    const d = DECOYS[word] || [word+"X", word+"Y"];
    return d.slice(0, 2);
}

function getSpeed() {
    return 1 + (round - 1) * 0.85;
}

function updateStatus() {
    const speed = getSpeed();
    const balText = balbalot ? ' !!BALBALOT!!' : '';
    document.getElementById('myStatus').innerText = `KRAV_OS // SPD: ${speed.toFixed(1)}x${balText}`;
    sendToPeer({type: 'statusUpdate', status: `KRAV_OS // SPD: ${speed.toFixed(1)}x${balText}`});
}

// ===== STATUS UPDATES =====
function setStatus(text, className) {
  const status = document.getElementById('status');
  status.textContent = text;
  status.className = className;
}

// ===== PEERJS FUNCTIONS =====
function initPeer() {
  peer = new Peer();
  
  peer.on('open', (id) => {
    myPeerId = id;
    setStatus('KRAV_NET // CONNECTED', 'connected');
  });

  peer.on('error', (err) => {
    setStatus('CONNECTION ERROR: ' + err.type, 'disconnected');
  });
}

function createGame() {
  if(!peer) return;
  isHost = true;
  myPeerId = peer.id;
  
  document.getElementById('menu').style.display = 'none';
  document.getElementById('waiting-screen').style.display = 'block';
  document.getElementById('roomCode').textContent = myPeerId;
  setStatus('WAITING FOR CONNECTION...', 'waiting');
  
  peer.on('connection', (connection) => {
    conn = connection;
    setupConnection();
  });
}

function showJoin() {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('join-screen').style.display = 'block';
}

function showMenu() {
  document.getElementById('join-screen').style.display = 'none';
  document.getElementById('waiting-screen').style.display = 'none';
  document.getElementById('ready-screen').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
}

function joinGame() {
  const id = document.getElementById('peerIdInput').value.trim();
  if(!id || !peer) return;
  
  isHost = false;
  setStatus('CONNECTING...', 'waiting');
  conn = peer.connect(id);
  
  conn.on('open', () => {
    setupConnection();
  });
  
  conn.on('error', (err) => {
    alert('Failed to connect: ' + err);
    setStatus('CONNECTION FAILED', 'disconnected');
    showMenu();
  });
}

function cancelHost() {
  showMenu();
  setStatus('KRAV_NET // CONNECTED', 'connected');
}

function backToMenu() {
  window.location.href = 'index.html';
}

function setupConnection() {
  setStatus('PEER CONNECTED', 'connected');
  
  conn.on('data', (data) => {
    handlePeerMessage(data);
  });
  
  conn.on('close', () => {
    onOpponentLeft();
  });

  showReadyScreen();
}

function showReadyScreen() {
  document.getElementById('join-screen').style.display = 'none';
  document.getElementById('waiting-screen').style.display = 'none';
  document.getElementById('ready-screen').style.display = 'block';
}

function setReady() {
  myReady = true;
  sendToPeer({type: 'READY'});
  document.getElementById('ready-screen').innerHTML = '<div style="color:#ffcc00; font-size:24px;">WAITING FOR OPPONENT...</div>';
  checkStart();
}

function checkStart() {
  if(myReady && peerReady) {
    if(isHost) {
      sendToPeer({type: 'START_GAME'});
      startMultiplayerGame();
    }
  }
}

function sendToPeer(msg) {
  if(conn && conn.open) {
    conn.send(msg);
  }
}

function handlePeerMessage(data) {
  if(data.type === 'READY') {
    peerReady = true;
    checkStart();
  }
  if(data.type === 'START_GAME') {
    startMultiplayerGame();
  }
  if(data.type === 'stageUpdate') {
    document.getElementById('oppScreen').innerHTML = data.html;
  }
  if(data.type === 'statusUpdate') {
    document.getElementById('oppStatus').innerText = data.status;
  }
  if(data.type === 'MOVE') {
    oChoice = data.move;
    checkResolve();
  }
  if(data.type === 'NEXT_STAGE') {
    stage = data.stage;
    next();
  }
  if(data.type === 'SUDDEN') {
    sudden();
  }
  if(data.type === 'TEKO') {
    tekoFlash();
  }
  if(data.type === 'REMATCH') {
    rematchRequest = true;
    checkRematch();
  }
}

function onOpponentLeft() {
  clearInterval(barTimer);
  musicStarted = false;
  setStatus('OPPONENT DISCONNECTED', 'disconnected');
  show('OPPONENT LEFT<br>DISCONNECTED');
  setTimeout(() => {
    window.location.href = 'index.html';
  }, 3000);
}

// ===== GAME FUNCTIONS =====
function startMultiplayerGame() {
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('game-area').style.display = 'flex';
  
  stage=0; round=1; balbalot=false; lock=false;
  pChoice=null; oChoice=null; suddenActive=false;
  
  document.getElementById('myBox').classList.remove('balbalot-shake');
  
  if(ctx.state==='suspended') ctx.resume();
  playMusic();
  next();
}

const $=id=>document.getElementById(id);

function show(h){
  $("myScreen").innerHTML=h;
  sendToPeer({type: 'stageUpdate', html: h});
}

function buttons(arr){
 if(lock) return;
 $("myButtons").innerHTML=arr.map(b=>
  `<button class='btn' onclick="press('${b.t}',${b.ok},${!!b.move})">${b.t}</button>`
 ).join("");
}

function startBar(baseMs){
 clearInterval(barTimer); barWidth=100;
 const speed = getSpeed();
 updateStatus();
 const interval = baseMs / speed;
 barTimer=setInterval(()=>{
  barWidth-=2; $("timeBar").style.width=barWidth+"%";
  if(barWidth<=0) triggerShame("קורבן!", "איטי מדי!");
 },interval);
}

function stopBar(){clearInterval(barTimer);}

function triggerShame(title, msg){
 stopBar(); lock=true;
 $("myBox").classList.remove("balbalot-shake");
 show(`<div class="shame-text" style="color:${title==='קורבן!'?'#ff0033':'#ffcc00'}">${title}</div>${msg}`);
 sendToPeer({type: 'lose'});
 setTimeout(()=>showEndMenu(false), 1000);
 stage=-1;
}

function showEndMenu(won) {
  lock = false;
  pChoice = oChoice = null;
  const html = won ? 
    `<div style="font-size:28px; color:var(--neon); margin:20px 0;">VICTORY!</div>` :
    `<div style="font-size:28px; color:var(--danger); margin:20px 0;">DEFEAT!</div>`;
  
  $("myButtons").innerHTML = `
    ${html}
    <button class='btn big' onclick="requestRematch()">REMATCH</button>
    <button class='btn big' onclick="exitGame()">EXIT TO MENU</button>
  `;
}

function requestRematch() {
  myReady = true;
  sendToPeer({type: 'REMATCH'});
  show('WAITING FOR OPPONENT...');
  $("myButtons").innerHTML = '<div style="color:#ffcc00; font-size:20px;">Requesting rematch...</div>';
  checkRematch();
}

function checkRematch() {
  if(myReady && rematchRequest) {
    myReady = false;
    peerReady = false;
    rematchRequest = false;
    startMultiplayerGame();
  }
}

function exitGame() {
  window.location.href = 'index.html';
}

function press(t,ok,isMove){
 if(stage===-1){ return; }
 if(!ok){ 
   pChoice = 'FAIL';
   sendToPeer({type: 'MOVE', move: 'FAIL'});
   triggerShame("קורבן!", "קלט שגוי!"); 
   return; 
 }

 if(stage===100){ 
   suddenActive=false; 
   stopBar();
   show(`<div style="font-size:28px; color:var(--neon);">VICTORY!</div>`);
   sendToPeer({type: 'win'});
   setTimeout(()=>showEndMenu(true), 1000);
   return; 
 }

 if(isMove){
   stopBar();
   pChoice = t;
   sendToPeer({type: 'MOVE', move: t});
   show('WAITING FOR OPPONENT...');
   $("myButtons").innerHTML = '';
   checkResolve();
   return;
 }

 if(isHost) {
   stage++;
   sendToPeer({type: 'NEXT_STAGE', stage});
   next();
 }
}

function next(){
 lock=false;
 
 if(stage === 0) {
   const text = balbalot ? "מגה חרב" : "מגה קרב";
   show(`STAGE 1\n${text}`);
   buttons([{t:text, ok:true}, ...getDecoys(text).map(x=>({t:x, ok:false}))]);
   startBar(80); stage=1;
 } else if(stage === 1) {
   const text = balbalot ? "סופר חרב" : "סופר קרב";
   show(`STAGE 2\n${text}`);
   buttons([{t:text, ok:true}, ...getDecoys(text).map(x=>({t:x, ok:false}))]);
   startBar(80); stage=2;
 } else if(stage === 2) {
   const text = balbalot ? "מגה מגה מגה חרב" : "מגה מגה מגה קרב";
   show(`CHANT!\n${text}`);
   buttons([{t:text, ok:true}, ...getDecoys(text).map(x=>({t:x, ok:false}))]);
   startBar(60); stage=3;
 } else if(stage === 3) {
   show(`ROUND ${round}\nGO!!`);
   const moves = balbalot ? MOVES.BAL : MOVES.NORMAL;
   buttons(moves.map(m => ({t:m, ok:true, move:true})));
   startBar(120); stage=30;
 } else if(stage === 4) {
   show("TEKO TEKO!");
   buttons([{t:"תיקו תיקו", ok:true}, ...getDecoys("תיקו תיקו").slice(0,1).map(x=>({t:x, ok:false}))]);
   startBar(80); stage=5;
 } else if(stage === 5) {
   stage=0; next();
 }
}

function checkResolve() {
  if(pChoice && oChoice) {
    // Handle fails
    if(pChoice === 'FAIL' || oChoice === 'FAIL') {
      if(pChoice === 'FAIL' && oChoice === 'FAIL') {
        triggerShame("קורבן!", "שניכם נכשלתם!");
      } else if(pChoice === 'FAIL') {
        triggerShame("קורבן!", "נכשלת ברצף!");
      } else {
        show(`<div style="font-size:28px; color:var(--neon);">ROUND WIN!</div>`);
        sendToPeer({type: 'win'});
        setTimeout(()=>showEndMenu(true), 1000);
      }
      return;
    }

    // Normal fight resolution
    const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
    const wins = [[list[0], list[3]], [list[1], list[0]], [list[2], list[1]], [list[3], list[2]]];
    const pW = wins.some(p => p[0] === pChoice && p[1] === oChoice);
    const cW = wins.some(p => p[0] === oChoice && p[1] === pChoice);
    
    show(`אתה: ${pChoice}\nיריב: ${oChoice}`);
    
    setTimeout(() => {
      if(pW) {
        show(`<div style="font-size:28px; color:var(--neon);">ROUND WIN!</div>`);
        sendToPeer({type: 'win'});
        setTimeout(()=>showEndMenu(true), 1000);
      } else if(cW) {
        triggerShame("מפסידן!", "הובסת בקרב!");
      } else {
        // TEKO
        pChoice = oChoice = null;
        round++;
        if(round === 3) {
          balbalot = true;
          $("myBox").classList.add("balbalot-shake");
        }
        if(round >= 4) {
          if(isHost) sendToPeer({type: 'SUDDEN'});
          sudden();
        } else {
          if(isHost) sendToPeer({type: 'TEKO'});
          tekoFlash();
        }
      }
    }, 500);
  }
}

function tekoFlash() {
  $("myScreen").classList.add("flash-yellow");
  setTimeout(() => {
    $("myScreen").classList.remove("flash-yellow");
    stage = 4;
    if(isHost) next();
  }, 800);
}

function sudden(){
 show(`<img src="https://img.mako.co.il/2016/05/26/petiber_i.jpg" class="amos-img">\nAMMOS PETIBER\nעמוס פטיבר!`);
 
 suddenActive=true;
 setTimeout(()=>{ 
   if(suddenActive){ 
     suddenActive=false; 
     triggerShame("מפסידן!", "עמוס שתה אותך!");
   }
 }, 1300);
 
 buttons([{t:"פטיבר עמוס", ok:true}, ...getDecoys("פטיבר עמוס").slice(0,1).map(x=>({t:x, ok:false}))]);
 stage=100;
}

// ===== INIT =====
initPeer();
</script>
</body>
</html>const $ = id => document.getElementById(id);
let peer, conn;
let isHost = false, myReady = false, peerReady = false, rematchRequest = false;
let stage = 0, round = 1, balbalot = false, barTimer, barWidth = 100;
let pChoice = null, oChoice = null, suddenActive = false;

const MOVES = { NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"], BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"] };

// --- CONNECTION LOGIC ---
function initMenu() {
    $("screen").innerHTML = "MEGA KRAV MP\nSELECT MODE";
    btns([
        {t: "HOST GAME", fn: hostGame},
        {t: "JOIN GAME", fn: joinMenu},
        {t: "BACK TO MENU", fn: () => window.location.href='index.html'}
    ]);
}

function hostGame() {
    isHost = true;
    peer = new Peer();
    peer.on('open', id => {
        $("screen").innerHTML = `ID שלך:\n<b style="color:white; font-size:30px">${id}</b>\n\nשלח ליריב...`;
        $("status").innerText = "WAITING FOR CONNECTION...";
    });
    peer.on('connection', c => setupConn(c));
}

function joinMenu() {
    $("screen").innerHTML = `הכנס ID של המארח:`;
    const input = document.createElement("input");
    input.id = "peerIdInput";
    $("screen").appendChild(input);
    btns([{t: "CONNECT", fn: () => {
        const id = $("peerIdInput").value;
        peer = new Peer();
        setupConn(peer.connect(id));
    }}]);
}

function setupConn(c) {
    conn = c;
    conn.on('open', () => {
        $("status").innerText = "CONNECTED";
        showReadyScreen();
    });
    conn.on('data', data => handleData(data));
    conn.on('close', () => onOpponentLeft());
}

// --- DATA HANDLING ---
function handleData(d) {
    if (d.type === 'READY') { peerReady = true; checkStart(); }
    if (d.type === 'START_GAME') { startGame(); }
    if (d.type === 'MOVE') { oChoice = d.move; checkResolve(); }
    if (d.type === 'NEXT_STAGE') { stage = d.stage; next(); }
    if (d.type === 'SUDDEN') { sudden(); }
    if (d.type === 'REMATCH') { rematchRequest = true; checkRematch(); }
    if (d.type === 'TEKO') { tekoFlash(); }
}

function send(type, data = {}) { if(conn) conn.send({type, ...data}); }

// --- GAME FLOW ---
function showReadyScreen() {
    $("screen").innerHTML = "CHALLENGER FOUND!\nREADY?";
    btns([{t: "I'M READY", fn: () => {
        myReady = true;
        send('READY');
        $("screen").innerHTML = "WAITING FOR OPPONENT...";
        $("buttons").innerHTML = "";
        checkStart();
    }}]);
}

function checkStart() {
    if (myReady && peerReady) {
        if (isHost) {
            send('START_GAME');
            startGame();
        }
    }
}

function startGame() {
    stage = 0; round = 1; balbalot = false;
    $("app").classList.remove("balbalot-shake");
    next();
}

function next() {
    const speed = 1 + (round - 1) * 0.85;
    if (stage === 0) {
        const text = balbalot ? "מגה חרב" : "מגה קרב";
        $("screen").innerHTML = `STAGE 1\n${text}`;
        btns([{t:text, ok:true}, {t:"מגה גרב", ok:false}]);
        startBar(80 / speed); stage = 1;
    } else if (stage === 1) {
        const text = balbalot ? "סופר חרב" : "סופר קרב";
        $("screen").innerHTML = `STAGE 2\n${text}`;
        btns([{t:text, ok:true}, {t:"סופר קרפ", ok:false}]);
        startBar(80 / speed); stage = 2;
    } else if (stage === 2) {
        const text = balbalot ? "מגה מגה מגה חרב" : "מגה מגה מגה קרב";
        $("screen").innerHTML = `CHANT!\n${text}`;
        btns([{t:text, ok:true}, {t:"מנה מנה מנה", ok:false}]);
        startBar(60 / speed); stage = 3;
    } else if (stage === 3) {
        $("screen").innerHTML = `ROUND ${round}\nGO!!`;
        btns((balbalot ? MOVES.BAL : MOVES.NORMAL).map(m => ({t:m, ok:true, move: true})));
        startBar(120 / speed);
    }
}

function startBar(interval) {
    clearInterval(barTimer); barWidth = 100;
    barTimer = setInterval(() => {
        barWidth -= 2; $("timeBar").style.width = barWidth + "%";
        if (barWidth <= 0) triggerShame("קורבן!", "איטי מדי!");
    }, interval);
}

function btns(arr) {
    $("buttons").innerHTML = arr.map(b => `<button class='btn' onclick="press('${b.t}', ${b.ok}, ${!!b.fn}, ${!!b.move})">${b.t}</button>`).join("");
    if (arr[0].fn) window.lastFns = arr;
}

function press(t, ok, isFn, isMove) {
    if (isFn) { window.lastFns.find(f => f.t === t).fn(); return; }
    if (!ok) { send('MOVE', {move: 'FAIL'}); triggerShame("קורבן!", "קלט שגוי!"); return; }
    if (stage === 100) { suddenActive = false; victory(); return; }
    if (isMove) {
        clearInterval(barTimer);
        pChoice = t;
        send('MOVE', {move: t});
        $("screen").innerHTML = "WAITING FOR OPPONENT...";
        $("buttons").innerHTML = "";
        checkResolve();
        return;
    }
    if (isHost) { stage++; send('NEXT_STAGE', {stage}); next(); }
}

function checkResolve() {
    if (pChoice && oChoice) {
        if (pChoice === 'FAIL' || oChoice === 'FAIL') {
            if (pChoice === 'FAIL' && oChoice === 'FAIL') triggerShame("קורבן!", "שניכם נכשלתם");
            else if (pChoice === 'FAIL') triggerShame("קורבן!", "נכשלת ברצף!");
            else victory();
            return;
        }
        const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
        const wins = [[list[0], list[3]], [list[1], list[0]], [list[2], list[1]], [list[3], list[2]]];
        const pW = wins.some(p => p[0] === pChoice && p[1] === oChoice);
        const cW = wins.some(p => p[0] === oChoice && p[1] === pChoice);

        if (pW) victory();
        else if (cW) triggerShame("מפסידן!", "הובסת!");
        else {
            pChoice = oChoice = null;
            round++;
            if (round === 3) { balbalot = true; $("app").classList.add("balbalot-shake"); }
            if (round >= 4) { if(isHost) send('SUDDEN'); sudden(); }
            else { if(isHost) send('TEKO'); tekoFlash(); }
        }
    }
}

function tekoFlash() {
    $("screen").innerHTML = "TEKO TEKO!";
    $("screen").classList.add("flash-yellow");
    setTimeout(() => { $("screen").classList.remove("flash-yellow"); if(isHost) next(); }, 800);
}

function sudden() {
    stage = 100;
    $("screen").innerHTML = `<img src="https://img.mako.co.il/2016/05/26/petiber_i.jpg" class="amos-img">\nעמוס פטיבר!`;
    suddenActive = true;
    setTimeout(() => { if (suddenActive) triggerShame("מפסידן!", "עמוס שתה אותך!"); }, 1300);
    btns([{t:"פטיבר עמוס", ok:true}]);
}

function triggerShame(title, msg) {
    clearInterval(barTimer);
    $("screen").innerHTML = `<div class="shame-text">${title}</div>${msg}`;
    showEndMenu();
}

function victory() {
    clearInterval(barTimer);
    $("screen").innerHTML = `<div class="shame-text" style="color:var(--neon)">נצחון!</div>`;
    showEndMenu();
}

function showEndMenu() {
    pChoice = oChoice = null;
    btns([
        {t: "REMATCH", fn: () => {
            myReady = true; send('REMATCH');
            $("screen").innerHTML = "WAITING FOR OPPONENT...";
            checkRematch();
        }},
        {t: "EXIT", fn: () => window.location.href='index.html'}
    ]);
}

function checkRematch() {
    if (myReady && rematchRequest) {
        myReady = peerReady = rematchRequest = false;
        startGame();
    }
}

function onOpponentLeft() {
    clearInterval(barTimer);
    $("screen").innerHTML = "OPPONENT LEFT.\nBACK TO MENU...";
    setTimeout(() => window.location.href='index.html', 3000);
}

initMenu();
</script>
</body>
</html>
