<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV MULTI</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
 background:#000;
 color:#33ff33;
 font-family:'Courier New',monospace;
 margin:0;
 text-transform:uppercase;
 display:flex;
 flex-direction:column;
 align-items:center;
}

.btn{
 width:90%;
 margin:6px;
 padding:14px;
 background:#002200;
 color:#33ff33;
 border:2px solid #33ff33;
 font-size:18px;
}

#timeWrap{
 width:90%;
 border:2px solid #33ff33;
 margin:6px;
 height:18px;
}

#timeBar{
 width:100%;
 height:100%;
 background:#33ff33;
 transition:width .1s linear;
}

#game-area{
 display:none;
 flex-direction:column;
 width:100%;
 align-items:center;
}

#debug{
 width:90%;
 height:120px;
 background:#001100;
 border:1px solid #33ff33;
 overflow:auto;
 font-size:10px;
 margin-top:6px;
}

.box{
 border:2px solid #33ff33;
 width:90%;
 margin:6px;
 padding:6px;
 text-align:center;
}

.balbalot-shake{
 animation:sh 0.15s infinite;
}
@keyframes sh{
 0%{transform:translate(0,0)}
 25%{transform:translate(2px,-1px)}
 50%{transform:translate(-2px,1px)}
 75%{transform:translate(1px,2px)}
 100%{transform:translate(0,0)}
}
</style>
</head>

<body>

<h2>MULTI MEGA KRAV</h2>

<div id="lobby" class="box">

<div id="menu">
 <button class="btn" onclick="createGame()">HOST GAME</button>
 <button class="btn" onclick="document.getElementById('join-screen').style.display='block'">JOIN GAME</button>
</div>

<div id="join-screen" style="display:none">
 <input id="peerIdInput" class="btn" placeholder="ENTER CODE"/>
 <button class="btn" onclick="joinGame()">CONNECT</button>
 <button class="btn" onclick="showMenu()">BACK</button>
</div>

<div id="waiting-screen" style="display:none">
 YOUR CODE:
 <div id="roomCode"></div>
 WAITING PLAYER...
</div>

<div id="status">OFFLINE</div>
</div>

<!-- GAME AREA -->
<div id="game-area">

 <div id="oppBox" class="box">
   <div id="oppScreen">RIVAL</div>
 </div>

 <div id="myBox" class="box">
   <div id="myScreen">READY</div>

   <div id="timeWrap">
     <div id="timeBar"></div>
   </div>

   <div id="myButtons"></div>
 </div>

 <button class="btn" onclick="rageQuit()">QUIT = קורבן</button>

 <div id="debug"></div>
</div>

<script>
// ===== DEBUG =====
function log(t){
 const d=document.getElementById("debug");
 d.innerHTML+=t+"<br>";
 d.scrollTop=9999;
}

// expose for onclick
window.press=press;
window.createGame=createGame;
window.joinGame=joinGame;
window.showMenu=showMenu;
window.rageQuit=rageQuit;

// ===== PEER =====
let peer,conn,isHost=false,myPeerId;

function initPeer(){
 peer=new Peer({debug:2});

 peer.on("open",id=>{
   myPeerId=id;
   log("MY ID "+id);
 });

 peer.on("connection",c=>{
   conn=c;
   setupConnection();
 });
}

function createGame(){
 isHost=true;
 document.getElementById("roomCode").textContent=myPeerId;

 document.getElementById("menu").style.display="none";
 document.getElementById("waiting-screen").style.display="block";
}

function joinGame(){
 const id=document.getElementById("peerIdInput").value.trim();
 conn=peer.connect(id);
 conn.on("open",setupConnection);
}

function showMenu(){
 document.getElementById("join-screen").style.display="none";
 document.getElementById("menu").style.display="block";
}

function setupConnection(){
 document.getElementById("lobby").style.display="none";
 document.getElementById("game-area").style.display="flex";

 conn.on("data",handlePeer);
 start();
}

function send(m){ if(conn?.open) conn.send(m); }

// ===== GAME =====
let stage=0,round=1,balbalot=false;
let pChoice=null,oChoice=null;
let bar,barW;

const MOVES=["בונגלו","פיירבול","צונמי","אונייה"];
const BEATS={בונגלו:"אונייה",פיירבול:"בונגלו",צונמי:"פיירבול",אונייה:"צונמי"};

// ===== FLOW =====
function start(){ stage=0; round=1; balbalot=false; next(); }

function next(){
 log("STAGE "+stage);

 if(stage===0){
   show("מגה קרב");
   buttons(["מגה קרב","מגע קרב"]);
   startBar(); stage=1;
 }

 else if(stage===1){
   show("סופר קרב");
   buttons(["סופר קרב","סופר כרב"]);
   startBar(); stage=2;
 }

 else if(stage===2){
   show("מגה מגה מגה קרב");
   buttons(["מגה מגה מגה קרב","מגה מגה קרב"]);
   startBar(); stage=3;
 }

 else if(stage===3){
   show("ARENA ROUND "+round);
   buttons(MOVES,true);
   startBar(120); stage=30;
 }

 else if(stage===4){
   show("תיקו תיקו");
   buttons(["תיקו תיקו","טיקו טיקו"]);
   startBar(); stage=5;
 }

 else if(stage===5){ stage=0; next(); }
}

function buttons(arr,isMove=false){
 const box=document.getElementById("myButtons");

 box.innerHTML=arr.map(t=>
  `<button class="btn" onclick="press('${t}',${isMove})">${t}</button>`
 ).join("");
}

function show(h){
 document.getElementById("myScreen").innerHTML=h;
 send({type:"view",h});
}

// ===== TIMER =====
function startBar(ms=80){
 clearInterval(bar);
 barW=100;

 bar=setInterval(()=>{
   barW-=3;
   document.getElementById("timeBar").style.width=barW+"%";

   if(barW<=0) shame("SLOW");
 },ms);
}

function stopBar(){ clearInterval(bar); }

// ===== INPUT =====
function press(t,isMove){
 log("PRESS "+t);

 if(isMove){
   pChoice=t;
   send({type:"move",t});
   checkResolve();
   return;
 }

 if(isHost){
   stage++;
   send({type:"stage",stage});
   next();
 }
}

// ===== PEER =====
function handlePeer(d){
 log("MSG "+d.type);

 if(d.type==="view")
   document.getElementById("oppScreen").innerHTML=d.h;

 if(d.type==="stage"){ stage=d.stage; next(); }

 if(d.type==="move"){ oChoice=d.t; checkResolve(); }

 if(d.type==="sudden") sudden();

 if(d.type==="rage"){
   show("האויב קורבן וברח!");
   setTimeout(()=>location.href="index.html",2500);
 }
}

// ===== RESOLVE =====
function checkResolve(){
 if(!pChoice||!oChoice) return;

 show("YOU:"+pChoice+"<br>RIVAL:"+oChoice);

 setTimeout(()=>{
   if(BEATS[pChoice]===oChoice) win();
   else if(BEATS[oChoice]===pChoice) shame("LOSE");
   else teko();
 },700);
}

function teko(){
 pChoice=oChoice=null;
 round++;

 if(round===3){
   balbalot=true;
   document.getElementById("myBox").classList.add("balbalot-shake");
 }

 if(round>=4){
   send({type:"sudden"});
   sudden();
 }
 else{ stage=4; next(); }
}

// ===== ENDINGS =====
function win(){
 show("מפצח! אתה ניצחת<br>פקודה: DRINK!");
 setTimeout(()=>location.href="index.html",3000);
}

function shame(r){
 stopBar();
 show("קורבן!!!<br>פקודה: MAKE STUPID MISSION");
 setTimeout(()=>location.href="index.html",3500);
}

function rageQuit(){
 send({type:"rage"});
 shame("RAGE QUIT");
}

// ===== SUDDEN =====
function sudden(){
 show("עמוס פטיבר!");
 buttons(["פטיבר עמוס","פתיבר עמוס"]);
 stage=100;
}

// ===== START =====
initPeer();
</script>

</body>
</html>
