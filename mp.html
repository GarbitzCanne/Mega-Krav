<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV: TOXIC UPDATE</title>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

:root {
  --neon: #39ff14;
  --neon-p2: #ff33ff;
  --bg: #050a05;
  --danger: #ff0033;
  --warn: #ffcc00;
}

body {
  background:#000;color:var(--neon);font-family:'VT323',monospace;
  margin:0;display:flex;justify-content:center;align-items:center;
  min-height:100vh;text-transform:uppercase;padding:10px;box-sizing:border-box;
}

/* CRT */
body::before{
 content:"";position:fixed;inset:0;
 background:linear-gradient(rgba(18,16,16,0)50%,rgba(0,0,0,.1)50%),
            linear-gradient(90deg,rgba(255,0,0,.04),rgba(0,255,0,.01),rgba(0,0,255,.04));
 background-size:100%3px,3px 100%;pointer-events:none;z-index:100;
}

#container{width:100%;max-width:900px;position:relative;z-index:5}

.game-area{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}

.player-box{
 max-width:400px;background:var(--bg);padding:15px;border:4px solid var(--neon);
 box-shadow:0 0 20px var(--neon);text-align:center;flex:1 1 300px
}
.player-box.p2{border-color:var(--neon-p2);box-shadow:0 0 10px var(--neon-p2)}

#lobby{
 max-width:500px;background:var(--bg);padding:30px;border:4px solid var(--neon);
 box-shadow:0 0 20px var(--neon);text-align:center;margin:0 auto;
}

#status{font-size:14px;margin-bottom:10px;padding:8px;border:2px solid #333;background:#000}
#status.connected{border-color:var(--neon)}
#status.waiting{border-color:var(--warn);animation:pulse 1s infinite}
@keyframes pulse{50%{opacity:.5}}

#debug{
 font-size:12px;background:#001100;border:1px dashed var(--neon);
 padding:6px;margin-top:8px;height:90px;overflow:auto;text-align:left;
}

#timeBarBox{width:100%;height:14px;background:#111;border:2px solid var(--neon)}
#timeBar{height:100%;width:100%;background:var(--neon);transition:.1s linear}

.screen{
 border:2px solid #113311;background:#000;padding:10px;min-height:180px;
 font-size:24px;margin-bottom:10px;display:flex;align-items:center;
 justify-content:center;white-space:pre-wrap;
}

.btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{
 width:100%;padding:15px;background:#0a1a0a;color:var(--neon);
 border:2px solid var(--neon);font-family:'VT323';font-size:22px;cursor:pointer
}
.btn:hover{background:var(--neon);color:#000}

.balbalot-shake{animation:shake .1s infinite;border-color:var(--danger)!important}
@keyframes shake{50%{transform:translate(-2px,2px)}}

.flash-yellow{background:rgba(255,204,0,.4)!important}
.flash-red{animation:flashRed .5s}
@keyframes flashRed{0%{background:#ff0000}}

.amos-img{width:120px;border:3px solid var(--danger);margin-bottom:10px}
</style>
</head>

<body>
<div id="container">

<div id="lobby">
 <h1>MEGA KRAV<br>TOXIC EDITION</h1>
 <div id="status" class="disconnected">KRAV_NET // DISCONNECTED</div>

 <div id="menu">
   <button class="btn" onclick="createGame()">HOST GAME</button>
   <button class="btn" onclick="showJoin()">JOIN GAME</button>
   <button class="btn" onclick="backToMenu()">BACK</button>
 </div>

 <div id="join-screen" style="display:none">
   <input id="peerIdInput" placeholder="ENTER HOST ID"/>
   <button class="btn" onclick="joinGame()">CONNECT</button>
   <button class="btn" onclick="showMenu()">BACK</button>
 </div>

 <div id="waiting-screen" style="display:none">
   YOUR ID:
   <div id="roomCode" onclick="copyId()"></div>
 </div>

 <div id="ready-screen" style="display:none">
   <button class="btn" onclick="setReady()">I'M READY</button>
 </div>

 <div id="debug">debug...</div>
</div>

<div id="game-area" class="game-area" style="display:none">

 <div class="player-box" id="myBox">
   <div id="timeBarBox"><div id="timeBar"></div></div>
   <div class="screen" id="myScreen"></div>
   <div id="myButtons" class="btn-grid"></div>
 </div>

 <div class="player-box p2">
   <div class="screen" id="oppScreen">WAITING...</div>
 </div>

</div>
</div>

<script>
// ===== DEBUG LOGGER =====
function log(t){
 const d=document.getElementById("debug");
 d.innerHTML+=t+"<br>"; d.scrollTop=9999;
}

// ===== AUDIO =====
const ctx=new(window.AudioContext||webkitAudioContext)();
function beep(f){const o=ctx.createOscillator();o.frequency.value=f;o.connect(ctx.destination);o.start();o.stop(ctx.currentTime+.1)}

// ===== PEER SETUP (FIXED) =====
let peer,conn,isHost=false,myPeerId;

function initPeer(){
 peer=new Peer({
   debug:2,
   config:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]}
 });

 peer.on("open",id=>{
   myPeerId=id;
   setStatus("CONNECTED","connected");
   log("MY ID: "+id);
 });

 // LISTENER ALWAYS ACTIVE
 peer.on("connection",c=>{
   log("INCOMING CONNECTION");
   conn=c; setupConnection();
 });

 peer.on("error",e=>{
   log("PEER ERR: "+e.type);
   setStatus("ERROR "+e.type,"disconnected");
 });
}

function setStatus(t,c){const s=document.getElementById("status");s.textContent=t;s.className=c}

// ===== LOBBY =====
function createGame(){
 isHost=true;
 roomCode.textContent=myPeerId;
 menu.style.display="none";
 waiting-screen.style.display="block";
 setStatus("WAITING","waiting");
}

function joinGame(){
 const id=peerIdInput.value.trim();
 conn=peer.connect(id,{reliable:true});

 conn.on("open",()=>{log("CONNECTED TO HOST");setupConnection()});
 conn.on("error",e=>log("CONN ERR "+e));
}

function setupConnection(){
 setStatus("LINKED","connected");
 lobby.style.display="none";
 game-area.style.display="flex";

 conn.on("data",handlePeer);
 conn.on("close",()=>{log("LEFT");location.href="index.html"});
}

function send(m){if(conn?.open)conn.send(m)}

// ===== GAME STATE =====
let stage=0,round=1,balbalot=false;
let pChoice,oChoice;
let bar,barW;

const MOVES=["בונגלו","פיירבול","צונמי","אונייה"];
const BEATS={בונגלו:"אונייה",פיירבול:"בונגלו",צונמי:"פיירבול",אונייה:"צונמי"};

// ===== FLOW =====
function start(){
 stage=0;round=1;balbalot=false;
 next();
}

function next(){
 log("STAGE "+stage);

 if(stage===0){show("מגה קרב");buttons(["מגה קרב","מגע קרב"]);startBar();stage=1}
 else if(stage===1){show("סופר קרב");buttons(["סופר קרב","סופר כרב"]);startBar();stage=2}
 else if(stage===2){show("מגה מגה מגה קרב");buttons(["מגה מגה מגה קרב","מגה מגה קרב"]);startBar();stage=3}

 else if(stage===3){
   show("ARENA ROUND "+round);
   buttons(MOVES,true);
   startBar(120);
   stage=30;
 }

 else if(stage===4){
   show("TEKO TEKO");
   buttons(["תיקו תיקו","טיקו תיקו"]);
   startBar();
   stage=5;
 }

 else if(stage===5){stage=0;next()}
}

function buttons(a,isMove){
 myButtons.innerHTML=a.map(t=>
  `<button class="btn" onclick="press('${t}',${isMove})">${t}</button>`
 ).join("");
}

function show(h){myScreen.innerHTML=h;send({type:"view",h})}

// ===== TIMER =====
function startBar(ms=80){
 clearInterval(bar);barW=100;
 bar=setInterval(()=>{barW-=3;timeBar.style.width=barW+"%";
   if(barW<=0)shame("SLOW")},ms)
}
function stopBar(){clearInterval(bar)}

// ===== INPUT =====
function press(t,isMove){
 if(isMove){
   pChoice=t; send({type:"move",t});
   checkResolve(); return;
 }

 // chants
 if(!isHost){
   show("WAIT HOST");
 }else{
   stage++; send({type:"stage",stage}); next();
 }
}

// ===== RESOLVE =====
function handlePeer(d){
 log("MSG "+d.type);

 if(d.type==="view")oppScreen.innerHTML=d.h;
 if(d.type==="stage"){stage=d.stage;next()}
 if(d.type==="move"){oChoice=d.t;checkResolve()}
 if(d.type==="sudden")sudden();
}

function checkResolve(){
 if(!pChoice||!oChoice)return;

 show("YOU:"+pChoice+"\nRIVAL:"+oChoice);

 setTimeout(()=>{
   if(BEATS[pChoice]===oChoice) win();
   else if(BEATS[oChoice]===pChoice) shame("LOSE");
   else teko();
 },800);
}

function teko(){
 pChoice=oChoice=null;
 round++;
 if(round===3){balbalot=true;myBox.classList.add("balbalot-shake")}

 if(round>=4){send({type:"sudden"});sudden()}
 else{stage=4;next()}
}

// ===== ENDINGS =====
function win(){
 show("VICTORY");
 send({type:"lose"});
 setTimeout(()=>location.href="index.html",2000);
}

function shame(r){
 stopBar();
 show("KORBAN\n"+r);
 send({type:"win"});
 setTimeout(()=>location.href="index.html",3000);
}

// ===== SUDDEN =====
function sudden(){
 show(`<img class="amos-img" src="https://img.mako.co.il/2016/05/26/petiber_i.jpg">
 עמוס פטיבר!`);
 buttons(["פטיבר עמוס","פתיבר עמוס"]);
 stage=100;
}

// ===== START =====
initPeer();
</script>
</body>
</html>
