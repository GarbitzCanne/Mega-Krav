<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MEGA KRAV</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
 background:#0a0a0f;
 color:#33ff33;
 font-family:monospace;
 text-align:center;
}
#screen{
 min-height:180px;
 border:2px solid #33ff33;
 margin:10px;
 padding:10px;
 white-space:pre-line;
}
.btn{
 display:block;
 width:90%;
 margin:6px auto;
 background:#001100;
 color:#33ff33;
 border:1px solid #33ff33;
 padding:10px;
}
.bar{
 height:12px;
 background:#330000;
 margin:6px;
}
.bar-inner{
 height:12px;
 background:#33ff33;
 width:100%;
}
</style>
</head>

<body>

<h2>MEGA KRAV ARCADE</h2>

<div id="screen"></div>
<div class="bar"><div id="bar" class="bar-inner"></div></div>

<div id="buttons"></div>
<div id="lobby"></div>

<script>
// ====== CORE STATE ======
let stage=0;       // 0 menu,1 challenge,2 chant,3 arena,4 result,5 balbalot,6 sudden
let mode="single"; // single/multi-host/multi-guest
let round=1;
let speed=1;
let lock=false;

let pMove=null;
let oMove=null;

// network
let peer=null;
let conn=null;

// timer bar
let barInt=null;
let bar=100;

// ====== RULES ======
const RULES={
 "בונגלו":"אוניה",
 "פיירבול":"בונגלו",
 "צונמי":"פיירבול",
 "אוניה":"צונמי"
};

const BAL={
 "בונגלו":"לונגבו",
 "פיירבול":"פיירדד",
 "צונמי":"נוצמי",
 "אוניה":"אוווניה"
};

// ====== UI ======
function show(t){ screen.innerHTML=t; }

function buttons(arr){
 let h="";
 arr.forEach(b=>{
  h+=`<button class="btn" onclick="${b.f}">${b.t}</button>`;
 });

 // BACK תמיד קיים
 h+=`<button class="btn" onclick="goMenu()">BACK TO MENU</button>`;
 buttonsDiv.innerHTML=h;
}

// ====== BAR ======
function startBar(sec,fail){
 clearInterval(barInt);
 bar=100;
 barInt=setInterval(()=>{
   bar-=100/(sec*10);
   if(bar<=0){
     clearInterval(barInt);
     korban("TIME FAIL");
   }
   barDiv.style.width=bar+"%";
 },100);
}

function stopBar(){
 clearInterval(barInt);
 barDiv.style.width="100%";
}

// ====== MENU ======
function menu(){
 show(`WELCOME TO MEGA KRAV
SELECT MODE`);
 buttons([
  {t:"SINGLE PLAYER",f:"startSingle()"},
  {t:"HOST MULTI",f:"host()"},
  {t:"JOIN MULTI",f:"joinPrompt()"}
 ]);
}

function goMenu(){
 // notify ragequit
 if(conn){
   try{ conn.send({type:"ragequit"}); }catch(e){}
 }

 stopBar();
 stage=0;
 lock=false;
 pMove=oMove=null;
 round=1;
 speed=1;

 try{ if(conn) conn.close(); }catch(e){}
 try{ if(peer) peer.destroy(); }catch(e){}

 lobby.innerHTML="";
 menu();
}

// ====== SINGLE ======
function startSingle(){
 mode="single";
 stage=1;
 challenge();
}

// ====== MULTI ======
function host(){
 mode="multi-host";
 peer=new Peer();
 peer.on("open",id=>{
   lobby.innerHTML="HOST CODE: "+id;
   show("WAITING GUEST...");
 });

 peer.on("connection",c=>{
   conn=c;
   setupConn();
   show("GUEST CONNECTED");
   buttons([{t:"START",f:"sendStart()"}]);
 });
}

function joinPrompt(){
 let id=prompt("ENTER CODE");
 if(!id)return;
 mode="multi-guest";
 peer=new Peer();

 peer.on("open",()=>{
   conn=peer.connect(id);
   setupConn();
   show("CONNECTING...");
 });
}

function setupConn(){
 conn.on("data",onData);
 conn.on("close",()=>korban("ENEMY DISCONNECT"));
}

function send(o){ if(conn) conn.send(o); }

function onData(o){
 if(o.type==="start") challenge();

 if(o.type==="pick"){
   oMove=o.v;
   if(pMove) resolve();
 }

 if(o.type==="ragequit"){
   show("ENEMY RAN AWAY\nKORBAN");
   buttons([{t:"MENU",f:"goMenu()"}]);
 }
}

function sendStart(){
 send({type:"start"});
 challenge();
}

// ====== GAME FLOW ======
function challenge(){
 stage=1;
 show("מגה קרב ?");
 startBar(4,()=>korban("NO SUPER KRAV"));
 buttons([{t:"סופר קרב",f:"chant()"}]);
}

function chant(){
 stage=2;
 stopBar();
 show("מגה מגה מגה קרב");
 startBar(3/speed,arena);
 buttons([{t:"GO ARENA",f:"arena()"}]);
}

function arena(){
 stage=3;
 stopBar();

 let opts=["בונגלו","פיירבול","צונמי","אוניה"];

 // balbalot mode
 if(round>=3){
   opts=opts.map(x=>BAL[x]);
 }

 show("ARENA ROUND "+round);

 let arr=opts.map(o=>({
   t:o,
   f:`pick('${o}')`
 }));

 startBar(4/speed,()=>korban("NO PICK"));
 buttons(arr);
}

function pick(v){
 if(lock)return;
 lock=true;
 stopBar();

 pMove=v;

 if(mode==="single"){
   let opts=Object.keys(RULES);
   oMove=opts[Math.floor(Math.random()*4)];
   resolve();
 }else{
   send({type:"pick",v});
 }
}

function resolve(){
 lock=false;

 // same
 if(pMove===oMove){
   draw();
   return;
 }

 // translate balbalot names
 let p=pMove, o=oMove;

 for(let k in BAL){
   if(BAL[k]===pMove) p=k;
   if(BAL[k]===oMove) o=k;
 }

 if(RULES[p]===o) win();
 else if(RULES[o]===p) lose();
 else draw();
}

function win(){
 show(`
YOU WIN
מפפסידן = ENEMY
`);
 buttons([{t:"MENU",f:"goMenu()"}]);
}

function lose(){
 show(`
YOU LOSE
מפפסידן = YOU
DRINK!
`);
 buttons([{t:"MENU",f:"goMenu()"}]);
}

function draw(){
 round++;

 if(round===3){
   balbalot();
   return;
 }

 if(round>3){
   sudden();
   return;
 }

 show("תיקו תיקו");
 speed*=2;
 buttons([{t:"NEXT",f:"challenge()"}]);
}

function balbalot(){
 show("שלב הבלבלות");
 speed*=2;
 buttons([{t:"ENTER BALBALOT",f:"challenge()"}]);
}

function sudden(){
 stage=6;
 show("SUDDEN DEATH\nפטיבר עמוס");

 startBar(3,()=>korban("SLOW PETIBER"));

 buttons([
  {t:"פטיבר עמוס",f:"suddenWin()"}
 ]);
}

function suddenWin(){
 win();
}

// ====== KORBAN ======
function korban(r){
 stopBar();
 show(`
KORBAN
${r}

MAKE STUPID MISSION
`);
 buttons([{t:"MENU",f:"goMenu()"}]);
}

// ====== INIT ======
menu();

</script>

</body>
</html>
