<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV ARCADE: TURBO</title>

<style>
:root {
  --neon: #33ff33;
  --bg: #050a05;
  --dark-green: #002200;
  --glitch-red: #ff0033;
}

body {
  background: #000;
  color: var(--neon);
  font-family: 'Courier New', monospace;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow: hidden;
  text-transform: uppercase;
}

/* CRT SCANLINE EFFECT */
body::before {
  content: " ";
  display: block;
  position: absolute;
  top: 0; left: 0; bottom: 0; right: 0;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
              linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
  z-index: 10;
  background-size: 100% 3px, 3px 100%;
  pointer-events: none;
}

#app {
  width: 100%;
  max-width: 440px;
  background: var(--bg);
  padding: 15px;
  border: 6px solid #222;
  box-shadow: 0 0 40px rgba(0,255,0,0.2), inset 0 0 20px #000;
  position: relative;
  z-index: 5;
}

#logo {
  white-space: pre;
  text-align: center;
  font-size: 10px;
  line-height: 1.1;
  color: var(--neon);
  text-shadow: 0 0 8px var(--neon);
  margin-bottom: 10px;
}

#timeBarBox {
  width: 100%;
  height: 14px;
  background: #001100;
  border: 2px solid var(--neon);
  margin-bottom: 15px;
  box-shadow: 0 0 10px rgba(51, 255, 51, 0.3);
}

#timeBar {
  height: 100%;
  width: 100%;
  background: var(--neon);
  transition: width 0.05s linear;
}

#screen {
  border: 3px solid #113311;
  background: #000800;
  padding: 20px;
  min-height: 180px;
  white-space: pre-line;
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 15px;
  text-shadow: 0 0 5px var(--neon);
  position: relative;
  overflow: hidden;
}

/* ARCADE BUTTONS */
.btn {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 16px;
  background: #1a331a;
  color: var(--neon);
  border: none;
  border-bottom: 5px solid #0a1a0a;
  border-radius: 4px;
  font-size: 20px;
  font-family: monospace;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.05s;
  position: relative;
}

.btn:active {
  transform: translateY(3px);
  border-bottom: 1px solid #0a1a0a;
  background: #2a552a;
}

/* ANIMATIONS */
.flash { animation: flashScreen .2s infinite; }
@keyframes flashScreen {
  0% { background: #440000; }
  100% { background: #000800; }
}

.shake { animation: shake .2s ease-in-out; }
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.balbalot-mode {
  border-color: var(--glitch-red) !important;
  color: var(--glitch-red) !important;
}
</style>
</head>

<body>
<div id="app">
<div id="logo">
  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
  █ MEGA KRAV ARCADE 92 █
  ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
</div>

<div id="timeBarBox">
 <div id="timeBar"></div>
</div>

<div id="screen"></div>
<div id="buttons"></div>
</div>

<script>
let stage=0, round=1, balbalot=false;
let barTimer, barWidth=100, barSpeed=3;
let playerMove, cpuMove;
let suddenActive=false, lockInput=false;

// ===== NEW ACTION AUDIO ENGINE =====
let audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let musicInterval;
// A darker, driving 80s bassline (E-G-A-E sequence)
const ACTION_BASS = [164.81, 164.81, 196.00, 220.00, 164.81, 164.81, 146.83, 130.81];

function beep(freq, ms=120, type="square") {
  let o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type;
  o.frequency.value=freq;
  g.gain.setValueAtTime(0.1, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+ms/1000);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime+ms/1000);
}

function startMusic() {
  stopMusic();
  let i=0;
  musicInterval=setInterval(()=>{
    // Bass note
    beep(ACTION_BASS[i % ACTION_BASS.length], 200, "sawtooth");
    // Snare-ish click every 2nd beat
    if(i%2===0) beep(50, 50, "triangle");
    i++;
  }, 250 - (round * 5));
}

function stopMusic(){ clearInterval(musicInterval); }

function sfxWin(){ 
  [440, 554, 659, 880].forEach((f,i) => setTimeout(()=>beep(f,150), i*100));
}

function sfxLose(){ 
  [220, 110, 80].forEach((f,i) => setTimeout(()=>beep(f,300, "sawtooth"), i*150));
}

// ===== UI HELPERS =====
function triggerShake() {
    const app = document.getElementById("app");
    app.classList.add("shake");
    setTimeout(() => app.classList.remove("shake"), 200);
}

// Rules & Decoys (Unchanged)
const ARENA={"בונגלו":"אוניה","פיירבול":"בונגלו","צונמי":"פיירבול","אוניה":"צונמי"};
const BAL={"לונגבו":"אוווניה","פיירדד":"לונגבו","נוצמי":"פיירדד","אוווניה":"נוצמי"};
const DECOY_BANK={"מגה קרב":["מגה קראב","מגע קרב","מגה קרבה"],"סופר קרב":["סופר קראב","סופ קרב","סופר כרב"],"מגה חרב":["מגה חרבה","מגע חרב","מגה חראב"],"סופר חרב":["סופר חרבה","סופ חרב","סופר חראב"],"תיקו תיקו":["טיקו תיקו","תיקו תיק","טיקו טיקו"],"פטיבר עמוס":["פטיבר אמוס","פטיבר עמוש","פתיבר עמוס"]};

function getDecoys(w){
  let d=[...(DECOY_BANK[w]||[])];
  while(d.length<3) d.push(w+Math.random().toString(36).slice(2,4));
  return [...new Set(d)].slice(0,3);
}

function show(t){ 
    const scr = document.getElementById("screen");
    scr.innerHTML=t;
    if(balbalot) scr.classList.add("balbalot-mode");
    else scr.classList.remove("balbalot-mode");
}

function renderButtons(list){
 if(lockInput) return;
 let h="";
 list.forEach(b=>{
  h+=`<button class='btn' onclick="handle('${b.t}',${b.ok})">${b.t}</button>`;
 });
 document.getElementById("buttons").innerHTML=h;
}

function startBar(){
 clearInterval(barTimer);
 barWidth=100;
 const bar=document.getElementById("timeBar");
 bar.className="";
 barTimer=setInterval(()=>{
  barWidth-=barSpeed;
  bar.style.width=barWidth+"%";
  if(barWidth<30) bar.style.background="#ff0000";
  else bar.style.background="#33ff33";
  if(barWidth<=0) korban("TOO SLOW");
 },120);
}

// Game Flow Logic
function korban(r){
 stopBar(); stopMusic(); sfxLose();
 triggerShake();
 lockInput=true;
 show("KORBAN!!\n(×_×)\n"+r+"\n\nCOMMAND:\nMAKE STUPID MISSION");
 renderButtons([{t:"NEW GAME",ok:true}]);
 stage=-1;
}

function win(){
 stopBar(); stopMusic(); sfxWin();
 lockInput=true;
 show("YOU WIN\nCOMPUTER מפסידן\n\nCOMMAND:\nDRINK!");
 renderButtons([{t:"NEW GAME",ok:true}]);
 stage=-1;
}

function lose(){
 stopBar(); stopMusic(); sfxLose();
 triggerShake();
 lockInput=true;
 show("MAFSIDAN [BEER]\nYOU ARE מפסידן\n\nCOMMAND:\nDRINK!");
 renderButtons([{t:"NEW GAME",ok:true}]);
 stage=-1;
}

function handle(text,ok){
 if(stage===-1){ start(); return; }
 if(!ok){ korban("LANGUAGE ERROR"); return; }
 if(stage===100){
  if(!suddenActive) return;
  suddenActive=false; win(); return;
 }
 if(stage===30){
  stopBar();
  playerMove=text;
  let opts=balbalot?Object.keys(BAL):Object.keys(ARENA);
  cpuMove=opts[Math.floor(Math.random()*opts.length)];
  show("=== VS ===\nYOU: "+playerMove+"\nCPU: ???");
  setTimeout(()=>{
   show("YOU: "+playerMove+"\nCPU: "+cpuMove);
   resolve();
  },700);
  return;
 }
 next();
}

function next(){
 lockInput=false;
 if(stage===0){
  let w=balbalot?"מגה חרב":"מגה קרב";
  show("PHASE 1\n"+w);
  renderButtons([{t:w,ok:true},...getDecoys(w).map(x=>({t:x,ok:false}))]);
  startBar(); stage=1; return;
 }
 if(stage===1){
  let w=balbalot?"סופר חרב":"סופר קרב";
  show("PHASE 2\n"+w);
  renderButtons([{t:w,ok:true},...getDecoys(w).map(x=>({t:x,ok:false}))]);
  startBar(); stage=2; return;
 }
 if(stage===2){
  let w=balbalot?"מגה מגה מגה חרב":"מגה מגה מגה קרב";
  show("CHANT\n"+w);
  renderButtons([{t:w,ok:true},{t:"מגה מגה קרב",ok:false},{t:"מגה מגה חרב",ok:false}]);
  startBar(); stage=3; return;
 }
 if(stage===3){ enterArena(); return; }
 if(stage===4){
  show("תיקו תיקו");
  renderButtons([{t:"תיקו תיקו",ok:true},...getDecoys("תיקו תיקו").map(x=>({t:x,ok:false}))]);
  startBar(); stage=0; return;
 }
 if(stage===99){
  show("SUDDEN DEATH\nפטיבר עמוס");
  suddenActive=true;
  let cpuTime=420+Math.random()*800;
  setTimeout(()=>{ if(suddenActive){ suddenActive=false; lose(); }},cpuTime);
  renderButtons([{t:"פטיבר עמוס",ok:true},...getDecoys("פטיבר עמוס").map(x=>({t:x,ok:false}))]);
  startBar(); stage=100; return;
 }
}

function enterArena(){
 show("ARENA ROUND "+round);
 let opts=balbalot?Object.keys(BAL):Object.keys(ARENA);
 renderButtons(opts.map(o=>({t:o,ok:true})));
 startBar(); stage=30;
}

function resolve(){
 let table=balbalot?BAL:ARENA;
 if(playerMove===cpuMove){ teko(); return; }
 if(table[playerMove]===cpuMove){ win(); return; }
 lose();
}

function teko(){
 round++;
 triggerShake();
 if(round===3){ balbalot=true; }
 if(round>=4){ stage=99; next(); return; }
 barSpeed+=1;
 show("תיקו תיקו\nROUND "+round);
 stage=4; next();
}

function start(){
 stage=0; round=1; balbalot=false; barSpeed=3; suddenActive=false; lockInput=false;
 if (audioCtx.state === 'suspended') { audioCtx.resume(); }
 startMusic();
 next();
}

// Trigger start on first interaction
document.addEventListener('click', function init() {
    start();
    document.removeEventListener('click', init);
}, {once: true});

show("READY?\n\nCLICK TO INSERT COIN");
</script>
</body>
</html>
