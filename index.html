<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>MEGA KRAV ARCADE</title>

<style>
body{
 background:#000;
 color:#33ff33;
 font-family:Courier New,monospace;
 text-align:center;
 margin:0;
}

#app{
 max-width:420px;
 margin:auto;
 border:3px solid #33ff33;
 padding:10px;
}

#barBox{
 width:100%;
 height:14px;
 border:2px solid #33ff33;
 margin-bottom:8px;
}

#bar{
 width:100%;
 height:100%;
 background:#33ff33;
}

#screen{
 min-height:200px;
 border:1px solid #115511;
 margin-bottom:8px;
 padding:10px;
 white-space:pre-line;
}

.btn{
 width:100%;
 margin:4px 0;
 padding:14px;
 background:#112211;
 color:#33ff33;
 border:1px solid #33ff33;
 font-size:16px;
}
</style>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

</head>
<body>

<div id="app">
<div id="barBox"><div id="bar"></div></div>
<div id="screen"></div>
<div id="buttons"></div>
<div id="lobby"></div>
</div>

<script>
// ===== DOM =====
const screen=document.getElementById("screen");
const buttonsDiv=document.getElementById("buttons");
const barDiv=document.getElementById("bar");
const lobby=document.getElementById("lobby");

// ===== STATE =====
let stage=0;
let mode="single";
let round=1;
let speed=1;
let lock=false;

let pMove=null;
let oMove=null;

let peer=null;
let conn=null;

let barInt=null;
let bar=100;

// ===== RULES =====
const RULES={
 "בונגלו":"אוניה",
 "פיירבול":"בונגלו",
 "צונמי":"פיירבול",
 "אוניה":"צונמי"
};

const BAL={
 "בונגלו":"לונגבו",
 "פיירבול":"פיירדד",
 "צונמי":"נוצמי",
 "אוניה":"אוווניה"
};

// ===== UI =====
function show(t){ screen.textContent=t; }

function buttons(arr){
 let h="";
 arr.forEach(b=>{
  h+=`<button class="btn" onclick="${b.f}">${b.t}</button>`;
 });

 h+=`<button class="btn" onclick="goMenu()">BACK TO MENU</button>`;
 buttonsDiv.innerHTML=h;
}

// ===== BAR =====
function startBar(sec){
 clearInterval(barInt);
 bar=100;

 barInt=setInterval(()=>{
   bar-=100/(sec*10);
   if(bar<=0){
     clearInterval(barInt);
     korban("TIME FAIL");
   }
   barDiv.style.width=bar+"%";
 },100);
}

function stopBar(){
 clearInterval(barInt);
 barDiv.style.width="100%";
}

// ===== MENU =====
function menu(){
 stage=0;
 show(
"MEGA KRAV ARCADE\n\n"+
"SELECT MODE"
 );
 buttons([
  {t:"SINGLE PLAYER",f:"startSingle()"},
  {t:"HOST MULTI",f:"host()"},
  {t:"JOIN MULTI",f:"joinPrompt()"}
 ]);
}

function goMenu(){
 if(conn){
   try{ conn.send({type:"ragequit"}); }catch(e){}
 }

 stopBar();
 stage=0;
 lock=false;
 pMove=oMove=null;
 round=1;
 speed=1;

 try{ if(conn) conn.close(); }catch(e){}
 try{ if(peer) peer.destroy(); }catch(e){}

 lobby.innerHTML="";
 menu();
}

// ===== SINGLE =====
function startSingle(){
 mode="single";
 stage=1;
 challenge();
}

// ===== MULTI =====
function host(){
 mode="multi-host";
 peer=new Peer();

 peer.on("open",id=>{
   lobby.innerHTML="HOST CODE: "+id;
   show("WAITING GUEST...");
 });

 peer.on("connection",c=>{
   conn=c;
   setupConn();
   show("GUEST CONNECTED");
   buttons([{t:"START",f:"sendStart()"}]);
 });
}

function joinPrompt(){
 let id=prompt("ENTER CODE");
 if(!id)return;

 mode="multi-guest";
 peer=new Peer();

 peer.on("open",()=>{
   conn=peer.connect(id);
   setupConn();
   show("CONNECTING...");
 });
}

function setupConn(){
 conn.on("data",onData);
 conn.on("close",()=>korban("ENEMY DISCONNECT"));
}

function send(o){ if(conn) conn.send(o); }

function onData(o){
 if(o.type==="start") challenge();

 if(o.type==="pick"){
   oMove=o.v;
   if(pMove) resolve();
 }

 if(o.type==="ragequit"){
   show("ENEMY RAN AWAY\nKORBAN");
   buttons([{t:"MENU",f:"goMenu()"}]);
 }
}

function sendStart(){
 send({type:"start"});
 challenge();
}

// ===== GAME FLOW =====
function challenge(){
 stage=1;
 show("מגה קרב ?");
 startBar(4);
 buttons([{t:"סופר קרב",f:"chant()"}]);
}

function chant(){
 stage=2;
 stopBar();
 show("מגה מגה מגה קרב");
 startBar(3/speed);
 buttons([{t:"GO ARENA",f:"arena()"}]);
}

function arena(){
 stage=3;
 stopBar();

 let opts=["בונגלו","פיירבול","צונמי","אוניה"];

 if(round>=3){
   opts=opts.map(x=>BAL[x]);
 }

 show("ARENA ROUND "+round);

 let arr=opts.map(o=>({
   t:o,
   f:`pick('${o}')`
 }));

 startBar(4/speed);
 buttons(arr);
}

// ===== PICK =====
function pick(v){
 if(lock)return;
 lock=true;
 stopBar();

 pMove=v;

 if(mode==="single"){
   let opts=Object.keys(RULES);
   oMove=opts[Math.floor(Math.random()*4)];
   resolve();
 }else{
   send({type:"pick",v});
 }
}

// ===== RESOLVE =====
function resolve(){
 lock=false;

 if(pMove===oMove){
   draw();
   return;
 }

 let p=pMove, o=oMove;

 for(let k in BAL){
   if(BAL[k]===pMove) p=k;
   if(BAL[k]===oMove) o=k;
 }

 if(RULES[p]===o) win();
 else if(RULES[o]===p) lose();
 else draw();
}

// ===== RESULTS =====
function win(){
 show(
"ASCII TROPHY\n"+
"  \\o/\n"+
"   |\n"+
"  / \\\n\n"+
"YOU WIN\nמפפסידן = ENEMY"
 );
 buttons([{t:"MENU",f:"goMenu()"}]);
}

function lose(){
 show(
"ASCII CHASER\n"+
"  >:-(\n\n"+
"YOU LOSE\nמפפסידן = YOU\nDRINK!"
 );
 buttons([{t:"MENU",f:"goMenu()"}]);
}

function draw(){
 round++;

 if(round===3){
   balbalot();
   return;
 }

 if(round>3){
   sudden();
   return;
 }

 show("תיקו תיקו");
 speed*=2;
 buttons([{t:"NEXT",f:"challenge()"}]);
}

function balbalot(){
 show("שלב הבלבלות");
 speed*=2;
 buttons([{t:"ENTER BALBALOT",f:"challenge()"}]);
}

// ===== SUDDEN =====
function sudden(){
 stage=6;
 show("SUDDEN DEATH\nפטיבר עמוס");

 startBar(3);

 buttons([
  {t:"פטיבר עמוס",f:"suddenWin()"}
 ]);
}

function suddenWin(){ win(); }

// ===== KORBAN =====
function korban(r){
 stopBar();

 show(
"ASCII CRY\n"+
" (T_T)\n\n"+
"KORBAN\n"+r+
"\nMAKE STUPID MISSION"
 );

 buttons([{t:"MENU",f:"goMenu()"}]);
}

// ===== INIT =====
menu();
</script>
</body>
</html>
