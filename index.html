<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV: KORBAN EDITION</title>
<style>
:root { --neon: #39ff14; --danger: #ff0033; --bg: #050a05; }
body { background: #000; color: var(--neon); font-family: 'Courier New', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }
body::after { content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); pointer-events: none; z-index: 10; }
#app { width: 95%; max-width: 450px; background: var(--bg); padding: 10px; border: 5px solid #222; box-shadow: 0 0 40px rgba(57, 255, 20, 0.2); position: relative; z-index: 5; text-align: center; }
#timeBarBox { width: 100%; height: 12px; background: #001100; border: 2px solid var(--neon); margin-bottom: 10px; overflow: hidden; }
#timeBar { height: 100%; width: 100%; background: var(--neon); transition: width 0.1s linear; }
#screen { border: 2px solid #113311; background: #000; padding: 15px; min-height: 280px; font-size: 18px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; white-space: pre-wrap; }
.amos-sprite { width: 130px; border: 2px solid var(--neon); margin: 10px 0; filter: contrast(1.5) sepia(1) hue-rotate(60deg); }
.btn { display: block; width: 100%; margin: 5px 0; padding: 14px; background: #0a1a0a; color: var(--neon); border: 2px solid var(--neon); font-family: 'Courier New'; font-size: 16px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
.btn:hover { background: var(--neon); color: #000; }
.btn:active { transform: scale(0.98); }
.flash-yellow { animation: f-yellow 0.1s infinite; }
@keyframes f-yellow { 0% { background: #000; } 50% { background: #443300; } 100% { background: #000; } }
.shake { animation: shake 0.2s infinite; }
@keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } }
pre { font-size: 10px; line-height: 1; color: var(--neon); margin: 0; }
.sass { color: var(--danger); font-size: 14px; margin-top: 10px; font-style: italic; }
</style>
</head>

<body>
<div id="app">
<div id="logo">▲ MEGA KRAV X - V2.0 ▲</div>
<div id="timeBarBox"><div id="timeBar"></div></div>
<div id="screen"></div>
<div id="buttons"></div>
</div>

<script>
// --- AUDIO ENGINE ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(f, type="square", dur=0.1) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}

// --- CONFIG & SASS ---
const MOVES = {
  NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"],
  BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"]
};
const SASS = [
    "סבתא שלי לוחצת יותר מהר.",
    "אתה קורבן של המערכת.",
    "אולי כדאי שתעבור לדוקים?",
    "ביצועים מביכים בהחלט.",
    "אמוס פטיבר מאוכזב ממך.",
    "טעות של טירון.",
    "לך תשתה שוקו ותחזור."
];
const ASCII = {
    SWORD: `  /\\ \n  || \n  || \n--||--\n  ||`,
    SHIELD: ` .---. \n/     \\ \n|  X  | \n\\     / \n '---' `
};

// --- LOGIC ---
let stage=0, round=1, balbalot=false, barTimer, barWidth=100, pChoice, cChoice, suddenActive=false;
const $ = id => document.getElementById(id);

function getWinner(m1, m2, isBal) {
    const list = isBal ? MOVES.BAL : MOVES.NORMAL;
    const winPairs = [
        [list[0], list[3]], // Bungalo > Onyia
        [list[1], list[0]], // Fireball > Bungalo
        [list[2], list[1]], // Tsunami > Fireball
        [list[3], list[2]]  // Onyia > Tsunami
    ];
    return winPairs.some(pair => pair[0] === m1 && pair[1] === m2);
}

function resolve() {
    const pW = getWinner(pChoice, cChoice, balbalot);
    const cW = getWinner(cChoice, pChoice, balbalot);

    if (pW) { win(); }
    else if (cW) { gameOver("הפסדת בקרב! שתה בירה."); }
    else {
        round++;
        playSound(200, "sawtooth", 0.3);
        $("screen").classList.add("flash-yellow");
        setTimeout(() => $("screen").classList.remove("flash-yellow"), 300);
        if (round === 3) balbalot = true;
        if (round >= 4) { sudden(); return; }
        stage = 4; next();
    }
}

// --- ENGINE ---
function next() {
    const W = balbalot 
        ? { chal: "מגה חרב", acc: "סופר חרב", chant: "מגה מגה מגה חרב" } 
        : { chal: "מגה קרב", acc: "סופר קרב", chant: "מגה מגה מגה קרב" };

    if (stage === 0) {
        show(`<pre>${ASCII.SWORD}</pre>${W.chal}`);
        btns([{ t: W.chal, ok: true }, { t: "מגע קרב", ok: false }, { t: "מגה גרב", ok: false }]);
        startBar(100); stage = 1;
    } else if (stage === 1) {
        show(`<pre>${ASCII.SHIELD}</pre>${W.acc}`);
        btns([{ t: W.acc, ok: true }, { t: "סופר כרב", ok: false }, { t: "סופר קרפ", ok: false }]);
        startBar(100); stage = 2;
    } else if (stage === 2) {
        show(`${W.chant}\nמהרררר!`);
        btns([{ t: W.chant, ok: true }, { t: "מגה מגה קרב", ok: false }, { t: "מגה מגה מגה קראב", ok: false }]);
        startBar(80); stage = 3;
    } else if (stage === 3) {
        show(`ARENA ROUND ${round}\nבחר מהלך!`);
        btns((balbalot ? MOVES.BAL : MOVES.NORMAL).map(m => ({ t: m, ok: true })));
        startBar(120); stage = 30;
    } else if (stage === 4) {
        show("TEKO TEKO!\nתיקו תיקו!");
        btns([{ t: "תיקו תיקו", ok: true }, { t: "טיקו טיקו", ok: false }]);
        startBar(100); stage = 5;
    } else if (stage === 5) {
        stage = 0; next();
    }
}

function press(t, ok) {
    if (stage === -1) { start(); return; }
    playSound(ok ? 600 : 150);
    if (!ok) { gameOver("קלט שגוי!"); return; }
    if (stage === 100) { suddenActive = false; stopBar(); win(); return; }
    
    if (stage === 30) {
        stopBar(); pChoice = t;
        const currentMoves = balbalot ? MOVES.BAL : MOVES.NORMAL;
        cChoice = currentMoves[Math.floor(Math.random() * 4)];
        show(`אתה: ${pChoice}\nיריב: <span class="shake">...</span>`);
        setTimeout(() => {
            show(`אתה: ${pChoice}\nיריב: ${cChoice}`);
            setTimeout(resolve, 800);
        }, 600);
        return;
    }
    next();
}

function startBar(speed) {
    clearInterval(barTimer); barWidth = 100;
    barTimer = setInterval(() => {
        barWidth -= 2.5; 
        $("timeBar").style.width = barWidth + "%";
        if (barWidth <= 0) gameOver("איטי מדי!");
    }, speed);
}

function stopBar() { clearInterval(barTimer); }
function show(h) { $("screen").innerHTML = h; }
function btns(arr) { 
    // Shuffle buttons to keep user on toes
    arr.sort(() => Math.random() - 0.5);
    $("buttons").innerHTML = arr.map(b => `<button class='btn' onclick="press('${b.t}', ${b.ok})">${b.t}</button>`).join(""); 
}

function win() { 
    playSound(800, "square", 0.5);
    show("NICE!\nניצחת את הסיבוב!"); 
    stage = -1; btns([{ t: "לסיבוב הבא", ok: true }]); 
}

function gameOver(msg) { 
    stopBar();
    playSound(100, "sawtooth", 0.6);
    const sassMsg = SASS[Math.floor(Math.random() * SASS.length)];
    show(`<span style="color:red">GAME OVER</span>\nאתה קורבן!\n${msg}\n<div class="sass">"${sassMsg}"</div>`); 
    stage = -1; btns([{ t: "נסה שוב, קורבן", ok: true }]); 
}

function sudden() {
    show(`!!! SUDDEN DEATH !!!\n<img src="https://img.mako.co.il/2016/05/26/petiber_i.jpg" class="amos-sprite">\nעמוס פטיבר הופיע!`);
    suddenActive = true;
    setTimeout(() => { if (suddenActive) gameOver("עמוס שתה אותך!"); }, 1800);
    btns([{ t: "פטיבר עמוס", ok: true }, { t: "פתיבר אמוס", ok: false }, { t: "פטיבר אמוס", ok: false }]);
    stage = 100;
}

function start() { stage = 0; round = 1; balbalot = false; next(); }

show("MEGA KRAV X\n\nלחץ להתחלה");
document.addEventListener("click", () => {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    start();
}, { once: true });
</script>
</body>
</html>
