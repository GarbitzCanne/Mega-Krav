<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV X ONLINE</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
:root{--neon:#33ff33;--bg:#050a05;--glitch-red:#ff0033}
body{
 background:#000;color:var(--neon);font-family:'Courier New',monospace;
 margin:0;display:flex;justify-content:center;align-items:center;
 height:100vh;overflow:hidden;text-transform:uppercase;
}
#app{
 width:100%;max-width:440px;background:var(--bg);padding:12px;
 border:4px solid #222;text-align:center;
}
#timeBarBox{width:100%;height:14px;background:#001100;border:2px solid var(--neon);}
#timeBar{height:100%;width:100%;background:var(--neon);}
#screen{
 border:2px solid #113311;background:#000;padding:14px;
 min-height:230px;margin-bottom:10px;display:flex;
 flex-direction:column;justify-content:center;align-items:center;
}
.btn{
 display:block;width:100%;margin:6px 0;padding:14px;
 background:#1a331a;color:var(--neon);border:none;
 border-bottom:4px solid #0a1a0a;font-size:17px;
}
.btn:active{transform:translateY(2px)}
pre.sprite{margin:0;font-size:15px}
.bounce{animation:bounce .5s infinite alternate}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-12px)}}
.shake{animation:shake .15s infinite}
@keyframes shake{0%,100%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}}
.flash{animation:f .12s 4}
@keyframes f{0%,100%{background:#000}50%{background:#224400}}
</style>
</head>

<body>
<div id="app">
<div id="logo">MEGA KRAV X - NET EDITION</div>
<div id="timeBarBox"><div id="timeBar"></div></div>
<div id="screen"></div>
<div id="buttons"></div>
</div>

<script>
// ===== NETWORK =====
let peer=null, conn=null;
let isHost=false, multiplayer=false;

// ===== STATE =====
let stage=0, round=1, balbalot=false, lock=false;
let barTimer=null, barWidth=100;
let p,c, suddenActive=false;

// ===== TABLES =====
const ARENA={ "בונגלו":"אוניה","פיירבול":"בונגלו","צונמי":"פיירבול","אוניה":"צונמי" };
const BAL  ={ "לונגבו":"אוווניה","פיירדד":"לונגבו","נוצמי":"פיירדד","אוווניה":"נוצמי" };

const WORDS={
 normal:{challenge:"מגה קרב",accept:"סופר קרב",chant:"מגה מגה מגה קרב"},
 bal:{challenge:"מגה חרב",accept:"סופר חרב",chant:"מגה מגה מגה חרב"}
};

const DECOY={
 "מגה קרב":["מגה קראב","מגע קרב","מגה קרבה"],
 "סופר קרב":["סופר קראב","סופ קרב","סופר כרב"],
 "מגה מגה מגה קרב":["מגה מגה קרב"],
 "תיקו תיקו":["טיקו תיקו","תיקו תיק"],
 "פטיבר עמוס":["פטיבר אמוס","פתיבר עמוס"]
};

// ===== HELPERS =====
const $=id=>document.getElementById(id);
function show(h){$("screen").innerHTML=h;}

function buttons(arr){
 if(lock) return;
 $("buttons").innerHTML=arr.map(b=>
  `<button class='btn' onclick="press('${b.t}',${b.ok})">${b.t}</button>`
 ).join("");
}

function startBar(){
 clearInterval(barTimer);barWidth=100;
 barTimer=setInterval(()=>{
  barWidth-=3;$("timeBar").style.width=barWidth+"%";
  if(barWidth<=0) korban("SLOW");
 },120);
}
function stopBar(){clearInterval(barTimer);}

// ===== ASCII =====
const ASCII={
 win:`<pre class="sprite bounce">
  \\o/
   |
  / \\
 VICTORY
</pre>`,
 lose:`<pre class="sprite shake">
  ___
 |   |
 | X |
 |___|
 LOSER
</pre>`,
 korban:`<pre class="sprite shake">
 (x_x)
 /| |\\
 KORBAN
</pre>`
};

// ===== ENDINGS =====
function korban(r){
 stopBar();lock=true;
 show(ASCII.korban+"<br>"+r);
 buttons([{t:"NEW GAME",ok:true}]);
 stage=-1;
}

function win(){
 stopBar();lock=true;
 show(ASCII.win+"YOU WIN");
 buttons([{t:"DRINK",ok:true}]);
 stage=-1;
}

function lose(){
 stopBar();lock=true;
 show(ASCII.lose+"YOU LOSE");
 buttons([{t:"RETRY",ok:true}]);
 stage=-1;
}

// ===== INPUT =====
function press(t,ok){
 if(stage===-1){menu();return;}
 if(!ok){korban("WRONG");return;}

 // MULTIPLAYER ROUTING
 if(multiplayer){
   if(!isHost){
     conn.send({type:"pick",value:t});
     show("WAIT HOST...");
     return;
   }
 }

 if(stage===100){
   if(!suddenActive)return;
   suddenActive=false;stopBar();win();return;
 }

 if(stage===30){fight(t);return;}
 next();
}

// ===== FLOW =====
function next(){
 lock=false;
 const W=balbalot?WORDS.bal:WORDS.normal;

 switch(stage){
 case 0:
   show(W.challenge);
   buttons([{t:W.challenge,ok:true},{t:"X",ok:false},{t:"Y",ok:false}]);
   startBar();stage=1;break;

 case 1:
   show(W.accept);
   buttons([{t:W.accept,ok:true},{t:"Z",ok:false}]);
   startBar();stage=2;break;

 case 2:
   show(W.chant);
   buttons([{t:W.chant,ok:true},{t:"BAD",ok:false}]);
   startBar();stage=3;break;

 case 3:
   enterArena();break;

 case 4:
   show("תיקו תיקו");
   buttons([{t:"תיקו תיקו",ok:true},{t:"טיקו",ok:false}]);
   startBar();stage=5;break;

 case 5:
   stage=0;next();break;
 }
}

// ===== ARENA =====
function enterArena(){
 show("ARENA "+round);
 let opts=Object.keys(balbalot?BAL:ARENA);
 buttons(opts.map(o=>({t:o,ok:true})));
 startBar();stage=30;
}

// HOST RESOLVES
function fight(sel){
 stopBar();lock=true;p=sel;

 let opts=Object.keys(balbalot?BAL:ARENA);

 if(multiplayer && isHost){
   // wait for remote pick
   c="WAITING";
 }else{
   c=opts[Math.floor(Math.random()*opts.length)];
 }

 show(`YOU:${p}<br>CPU:${c}`);

 if(!multiplayer || isHost)
   setTimeout(resolve,700);
}

function resolve(remotePick){
 if(remotePick) c=remotePick;

 let T=balbalot?BAL:ARENA;

 if(p===c){
   round++;
   if(round===3) balbalot=true;
   if(round>=4){sudden();return;}
   stage=4;next();return;
 }

 (T[p]===c)?win():lose();
}

// ===== SUDDEN =====
function sudden(){
 show("<div class='flash'>SUDDEN DEATH</div>פטיבר עמוס");
 suddenActive=true;

 setTimeout(()=>{if(suddenActive){suddenActive=false;lose();}},900);

 buttons([{t:"פטיבר עמוס",ok:true},{t:"פטיבר אמוס",ok:false}]);
 startBar();stage=100;
}

// ===== NETWORK =====
function host(){
 multiplayer=true;isHost=true;
 peer=new Peer();

 peer.on('open',id=>{
   show("ROOM CODE:<br>"+id);
 });

 peer.on('connection',c=>{
   conn=c;
   show("PLAYER JOINED");
   conn.on('data',m=>{
     if(m.type==="pick"){
       resolve(m.value);
     }
   });
   setTimeout(start,800);
 });
}

function join(){
 let id=prompt("ENTER ROOM CODE");
 if(!id)return;

 multiplayer=true;isHost=false;
 peer=new Peer();

 peer.on('open',()=>{
   conn=peer.connect(id);
   conn.on('open',()=>{
     show("CONNECTED");
     setTimeout(start,800);
   });
 });
}

// ===== MENU =====
function menu(){
 stage=0;round=1;balbalot=false;lock=false;
 multiplayer=false;isHost=false;

 show(`
<pre class="sprite">
MEGA KRAV X
ONLINE
</pre>
`);

 buttons([
  {t:"SINGLE PLAYER",ok:true,act:()=>{multiplayer=false;start();}},
  {t:"HOST GAME",ok:true,act:host},
  {t:"JOIN GAME",ok:true,act:join}
 ]);

 // override actions
 document.querySelectorAll(".btn").forEach((b,i)=>{
   b.onclick=buttons()[i]?.act;
 });
}

// ===== START =====
function start(){
 stage=0;round=1;balbalot=false;lock=false;
 next();
}

menu();
</script>
</body>
</html>
