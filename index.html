<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV: KORBAN EDITION</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
:root { --neon: #39ff14; --danger: #ff0033; --warn: #ffcc00; --bg: #0a0a0a; }

body { background: #000; color: var(--neon); font-family: 'VT323', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }

/* CRT OVERLAY - CRITICAL FIX: pointer-events: none */
body::before { content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03)); z-index: 100; background-size: 100% 3px, 3px 100%; pointer-events: none; }

#app { width: 90%; max-width: 420px; background: var(--bg); padding: 20px; border: 4px solid var(--neon); box-shadow: 0 0 15px var(--neon); position: relative; z-index: 5; text-align: center; }
#screen { border: 2px solid #113311; background: #000; padding: 15px; min-height: 250px; font-size: 26px; margin-bottom: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; white-space: pre-wrap; line-height: 1.2; }
#timeBarBox { width: 100%; height: 15px; background: #111; border: 2px solid var(--neon); margin-bottom: 15px; }
#timeBar { height: 100%; width: 100%; background: var(--neon); box-shadow: 0 0 10px var(--neon); }

.btn { display: block; width: 100%; margin: 6px 0; padding: 12px; background: #111; color: var(--neon); border: 2px solid var(--neon); font-family: 'VT323'; font-size: 22px; cursor: pointer; transition: 0.1s; }
.btn:hover { background: var(--neon); color: #000; }

.korban { color: var(--danger); font-size: 55px; text-shadow: 0 0 15px red; animation: shake 0.1s infinite; margin-bottom: 10px; }
@keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
.sass { color: var(--warn); font-size: 18px; font-style: italic; margin-top: 10px; }
pre { font-size: 12px; line-height: 1; color: var(--warn); margin: 0; }
</style>
</head>

<body>
<div id="app">
    <div style="font-size:14px; letter-spacing: 2px; margin-bottom: 5px;">KRAV_OS_V2.0 // STATUS: READY</div>
    <div id="timeBarBox"><div id="timeBar"></div></div>
    <div id="screen"></div>
    <div id="buttons"></div>
</div>

<script>
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let musicStarted = false;

function playMusic() {
    if (musicStarted) return; musicStarted = true;
    const sequence = [110, 0, 110, 110, 82, 0, 98, 123]; // BroForce-ish Bass
    let i = 0;
    setInterval(() => {
        if (sequence[i] > 0) {
            const osc = ctx.createOscillator(), g = ctx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = sequence[i];
            g.gain.setValueAtTime(0.1, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            osc.connect(g); g.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        }
        i = (i + 1) % sequence.length;
    }, 200);
}

const MOVES = {
    NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"],
    BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"]
};

const SASS = [
    "סבתא שלי לוחצת מהר יותר.",
    "אתה מביך את המשפחה שלך.",
    "קורבן טיפוסי של המערכת.",
    "אולי דוקים יתאים לך יותר?",
    "ביצועים של שקית במבה פתוחה."
];

let stage=0, round=1, balbalot=false, barTimer, barWidth=100, pChoice, cChoice, suddenActive=false;
const $ = id => document.getElementById(id);

function show(h) { $("screen").innerHTML = h; }
function btns(arr) { 
    // FIXED ORDER - NO SHUFFLE
    $("buttons").innerHTML = arr.map(b => `<button class='btn' onclick="press('${b.t}', ${b.ok})">${b.t}</button>`).join(""); 
}

function startBar(speed) {
    clearInterval(barTimer); barWidth = 100;
    barTimer = setInterval(() => {
        barWidth -= 2; $("timeBar").style.width = barWidth + "%";
        if (barWidth <= 0) triggerKorban("לא עמדת בקצב!");
    }, speed);
}

function triggerKorban(msg) {
    clearInterval(barTimer);
    const insult = SASS[Math.floor(Math.random() * SASS.length)];
    show(`<div class="korban">קורבן!</div>${msg}\n<div class="sass">"${insult}"</div>`);
    stage = -1;
    btns([{t: "נסה שוב, לוזר", ok: true}]);
}

function resolve() {
    const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
    const wins = [[list[0], list[3]], [list[1], list[0]], [list[2], list[1]], [list[3], list[2]]];
    const pW = wins.some(p => p[0] === pChoice && p[1] === cChoice);
    const cW = wins.some(p => p[0] === cChoice && p[1] === pChoice);

    if (pW) { show("ROUND WIN!"); stage = -1; btns([{t:"המשך", ok:true}]); }
    else if (cW) { triggerKorban("הובסת בקרב!"); }
    else {
        round++;
        if (round === 3) balbalot = true;
        if (round >= 4) { sudden(); return; }
        stage = 4; next();
    }
}

function next() {
    if (stage === 0) {
        const text = balbalot ? "מגה חרב" : "מגה קרב";
        show(`STAGE 1\n${text}`);
        btns([{t:text, ok:true}, {t:"מגע קרב", ok:false}, {t:"מגה גרב", ok:false}, {t:"מפה קרב", ok:false}]);
        startBar(80); stage = 1;
    } else if (stage === 1) {
        const text = balbalot ? "סופר חרב" : "סופר קרב";
        show(`STAGE 2\n${text}`);
        btns([{t:text, ok:true}, {t:"סופר כרב", ok:false}, {t:"סופר קרפ", ok:false}, {t:"סופר סרב", ok:false}]);
        startBar(80); stage = 2;
    } else if (stage === 2) {
        const text = balbalot ? "מגה מגה מגה חרב" : "מגה מגה מגה קרב";
        show(`CHANT!\n${text}`);
        btns([{t:text, ok:true}, {t:"מגה מגה קרב", ok:false}, {t:"מגה מגה מגה כרב", ok:false}, {t:"מנה מנה מנה קרב", ok:false}]);
        startBar(60); stage = 3;
    } else if (stage === 3) {
        show(`ROUND ${round}\nGO!!`);
        btns((balbalot ? MOVES.BAL : MOVES.NORMAL).map(m => ({t:m, ok:true})));
        startBar(120); stage = 30;
    } else if (stage === 4) {
        show("TEKO TEKO!");
        btns([{t:"תיקו תיקו", ok:true}, {t:"טיקו טיקו", ok:false}, {t:"תיקו תיק", ok:false}]);
        startBar(80); stage = 5;
    } else if (stage === 5) { stage = 0; next(); }
}

function press(t, ok) {
    if (stage === -1) { start(); return; }
    if (!ok) { triggerKorban("קלט שגוי!"); return; }
    if (stage === 100) { suddenActive = false; stage = -1; show("VICTORY!"); btns([{t:"שחק שוב", ok:true}]); return; }
    if (stage === 30) {
        clearInterval(barTimer); pChoice = t;
        const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
        cChoice = list[Math.floor(Math.random()*4)];
        show(`אתה: ${pChoice}\nיריב: ${cChoice}`);
        setTimeout(resolve, 800);
        return;
    }
    next();
}

function sudden() {
    show(`SUDDEN DEATH!!\nAMMOS PETIBER\nעמוס פטיבר!`);
    suddenActive = true;
    setTimeout(() => { if (suddenActive) triggerKorban("עמוס שתה אותך!"); }, 1800);
    btns([{t:"פטיבר עמוס", ok:true}, {t:"פתיבר אמוס", ok:false}]);
    stage = 100;
}

function start() { stage = 0; round = 1; balbalot = false; next(); }

show("MEGA KRAV X\n\n[CLICK TO START]");
document.addEventListener("click", () => {
    if(ctx.state === 'suspended') ctx.resume();
    playMusic();
    start();
}, { once: true });
</script>
</body>
</html>
