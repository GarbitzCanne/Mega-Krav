<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV: OVERDRIVE II</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
:root { --neon: #39ff14; --danger: #ff0033; --warn: #ffcc00; --bg: #050a05; }

body { background: #000; color: var(--neon); font-family: 'VT323', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; text-transform: uppercase; }

/* CRT OVERLAY */
body::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04)); z-index: 100; background-size: 100% 3px, 3px 100%; pointer-events: none; }

#app { width: 90%; max-width: 420px; background: var(--bg); padding: 15px; border: 4px solid var(--neon); box-shadow: 0 0 20px var(--neon); position: relative; z-index: 5; text-align: center; transition: transform 0.1s; }
#screen { border: 2px solid #113311; background: #000; padding: 10px; min-height: 280px; font-size: 24px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; white-space: pre-wrap; transition: background 0.2s; }
#timeBarBox { width: 100%; height: 14px; background: #111; border: 2px solid var(--neon); margin-bottom: 10px; }
#timeBar { height: 100%; width: 100%; background: var(--neon); box-shadow: 0 0 10px var(--neon); }

.btn { display: block; width: 100%; margin: 5px 0; padding: 10px; background: #0a1a0a; color: var(--neon); border: 2px solid var(--neon); font-family: 'VT323'; font-size: 22px; cursor: pointer; }
.btn:hover { background: var(--neon); color: #000; }

/* ANIMATIONS */
.shame-text { font-size: 50px; text-shadow: 0 0 15px red; animation: glitch 0.1s infinite; }
@keyframes glitch { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }

.balbalot-shake { animation: shake-heavy 0.2s infinite; border-color: var(--danger) !important; }
@keyframes shake-heavy { 0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-2px, -1px) rotate(1deg); } 40% { transform: translate(2px, 1px) rotate(-1deg); } 100% { transform: translate(-1px, 2px) rotate(0deg); } }

.flash-yellow { background: rgba(255, 204, 0, 0.4) !important; }

.amos-img { width: 120px; height: 120px; border: 3px solid var(--danger); filter: contrast(1.5) grayscale(0.5); image-rendering: pixelated; margin-bottom: 10px; }
</style>
</head>

<body>
<div id="app">
    <div id="status" style="font-size:12px; margin-bottom: 5px;">KRAV_OS // SPD: 1.0x</div>
    <div id="timeBarBox"><div id="timeBar"></div></div>
    <div id="screen"></div>
    <div id="buttons"></div>
</div>

<script>
const ctx = new (window.AudioContext || window.webkitAudioContext)();
let musicStarted = false;

function playMusic() {
    if (musicStarted) return; musicStarted = true;
    const sequence = [110, 0, 110, 110, 82, 0, 98, 123]; 
    let i = 0;
    setInterval(() => {
        if (sequence[i] > 0) {
            const osc = ctx.createOscillator(), g = ctx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = sequence[i];
            g.gain.setValueAtTime(0.08, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
            osc.connect(g); g.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.25);
        }
        i = (i + 1) % sequence.length;
    }, 180);
}

const MOVES = {
    NORMAL: ["בונגלו", "פיירבול", "צונמי", "אונייה"],
    BAL: ["לונגבו", "פיירדד", "נוצמי", "אוווניה"]
};

let stage=0, round=1, balbalot=false, barTimer, barWidth=100, pChoice, cChoice, suddenActive=false;
const $ = id => document.getElementById(id);

function getSpeed() { return 1 + (round - 1) * 0.85; }

function startBar(baseMs) {
    clearInterval(barTimer); barWidth = 100;
    const speed = getSpeed();
    $("status").innerText = `KRAV_OS // SPD: ${speed.toFixed(1)}x ${balbalot ? '!!BALBALOT!!' : ''}`;
    const interval = baseMs / speed;
    barTimer = setInterval(() => {
        barWidth -= 2; $("timeBar").style.width = barWidth + "%";
        if (barWidth <= 0) triggerShame("קורבן!", "איטי מדי!");
    }, interval);
}

function triggerShame(title, msg) {
    clearInterval(barTimer);
    $("app").classList.remove("balbalot-shake");
    $("screen").innerHTML = `<div class="shame-text" style="color:${title==='קורבן!'?'#ff0033':'#ffcc00'}">${title}</div>${msg}`;
    stage = -1;
    btns([{t: "נסה שוב", ok: true}]);
}

function resolve() {
    const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
    const wins = [[list[0], list[3]], [list[1], list[0]], [list[2], list[1]], [list[3], list[2]]];
    const pW = wins.some(p => p[0] === pChoice && p[1] === cChoice);
    const cW = wins.some(p => p[0] === cChoice && p[1] === pChoice);

    if (pW) { $("screen").innerHTML = "ROUND WIN!"; stage = -1; btns([{t:"המשך", ok:true}]); }
    else if (cW) { triggerShame("מפסידן!", "הובסת בקרב!"); }
    else {
        round++;
        if (round === 3) { balbalot = true; $("app").classList.add("balbalot-shake"); }
        if (round >= 4) { sudden(); return; }
        stage = 4;
        $("screen").classList.add("flash-yellow");
        setTimeout(() => $("screen").classList.remove("flash-yellow"), 300);
        next();
    }
}

function next() {
    if (stage === 0) {
        const text = balbalot ? "מגה חרב" : "מגה קרב";
        $("screen").innerHTML = `STAGE 1\n${text}`;
        btns([{t:text, ok:true}, {t:"מגע קרב", ok:false}, {t:"מגה גרב", ok:false}]);
        startBar(80); stage = 1;
    } else if (stage === 1) {
        const text = balbalot ? "סופר חרב" : "סופר קרב";
        $("screen").innerHTML = `STAGE 2\n${text}`;
        btns([{t:text, ok:true}, {t:"סופר כרב", ok:false}, {t:"סופר קרפ", ok:false}]);
        startBar(80); stage = 2;
    } else if (stage === 2) {
        const text = balbalot ? "מגה מגה מגה חרב" : "מגה מגה מגה קרב";
        $("screen").innerHTML = `CHANT!\n${text}`;
        btns([{t:text, ok:true}, {t:"מגה מגה קרב", ok:false}, {t:"מנה מנה מנה קרב", ok:false}]);
        startBar(60); stage = 3;
    } else if (stage === 3) {
        $("screen").innerHTML = `ROUND ${round}\nGO!!`;
        btns((balbalot ? MOVES.BAL : MOVES.NORMAL).map(m => ({t:m, ok:true})));
        startBar(120); stage = 30;
    } else if (stage === 4) {
        $("screen").innerHTML = "TEKO TEKO!";
        btns([{t:"תיקו תיקו", ok:true}, {t:"טיקו תיקו", ok:false}]);
        startBar(80); stage = 5;
    } else if (stage === 5) { stage = 0; next(); }
}

function press(t, ok) {
    if (stage === -1) { start(); return; }
    if (!ok) { triggerShame("קורבן!", "קלט שגוי!"); return; }
    if (stage === 100) { suddenActive = false; stage = -1; $("screen").innerHTML = "VICTORY!"; btns([{t:"שחק שוב", ok:true}]); return; }
    if (stage === 30) {
        clearInterval(barTimer); pChoice = t;
        const list = balbalot ? MOVES.BAL : MOVES.NORMAL;
        cChoice = list[Math.floor(Math.random()*4)];
        $("screen").innerHTML = `אתה: ${pChoice}\nיריב: ${cChoice}`;
        setTimeout(resolve, 500);
        return;
    }
    next();
}

function sudden() {
    $("screen").innerHTML = `<img src="https://img.mako.co.il/2016/05/26/petiber_i.jpg" class="amos-img">\nAMMOS PETIBER\nעמוס פטיבר!`;
    suddenActive = true;
    setTimeout(() => { if (suddenActive) triggerShame("מפסידן!", "עמוס שתה אותך!"); }, 1300);
    btns([{t:"פטיבר עמוס", ok:true}, {t:"פתיבר אמוס", ok:false}]);
    stage = 100;
}

function btns(arr) { 
    $("buttons").innerHTML = arr.map(b => `<button class='btn' onclick="press('${b.t}', ${b.ok})">${b.t}</button>`).join(""); 
}

function start() { $("app").classList.remove("balbalot-shake"); stage = 0; round = 1; balbalot = false; next(); }

$("screen").innerHTML = "MEGA KRAV: OVERDRIVE II\n\n[CLICK TO START]";
document.addEventListener("click", () => {
    if(ctx.state === 'suspended') ctx.resume();
    playMusic();
    start();
}, { once: true });
</script>
</body>
</html>
