<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>MEGA KRAV X ONLINE</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{
 background:#000;
 color:#33ff33;
 font-family:Courier New, monospace;
 text-align:center;
 margin:0;
}
#app{max-width:440px;margin:auto;padding:10px;}
.btn{
 width:100%;margin:6px 0;
 padding:14px;background:#102010;
 color:#33ff33;border:1px solid #33ff33;
}
#bar{height:12px;background:#33ff33;width:100%;}
pre{font-size:14px;}
</style>
</head>

<body>
<div id="app">
<h3>MEGA KRAV X ONLINE</h3>

<div id="menu"></div>
<div id="lobby"></div>

<div id="bar"></div>
<div id="screen"></div>
<div id="buttons"></div>
</div>

<script>
// ===== CORE STATE =====
let mode="single"; // single / host / join
let peer, conn;

let stage=0, round=1, bal=false;
let lock=false;

let timer=null, bar=100;

let pMove=null, oMove=null;

// ===== RULES =====
const ARENA={
"בונגלו":"אוניה",
"פיירבול":"בונגלו",
"צונמי":"פיירבול",
"אוניה":"צונמי"
};

const BAL={
"לונגבו":"אוווניה",
"פיירדד":"לונגבו",
"נוצמי":"פיירדד",
"אוווניה":"נוצמי"
};

const WORD={
n:{c:"מגה קרב",a:"סופר קרב",ch:"מגה מגה מגה קרב"},
b:{c:"מגה חרב",a:"סופר חרב",ch:"מגה מגה מגה חרב"}
};

const DECOY={
"מגה קרב":["מגע קרב","מגה קראב"],
"סופר קרב":["סופר קראב","סופ קרב"],
"מגה מגה מגה קרב":["מגה מגה קרב"],
"תיקו תיקו":["טיקו תיקו","תיקו תיק"],
"פטיבר עמוס":["פטיבר אמוס","פתיבר עמוס"]
};

function d(w){
 return [{t:w,ok:true},
 ...(DECOY[w]||[]).map(x=>({t:x,ok:false}))];
}

// ===== UI =====
const $=id=>document.getElementById(id);
function show(h){$("screen").innerHTML=h;}

function buttons(a){
 if(lock)return;
 $("buttons").innerHTML=a.map(b=>
 `<button class="btn" onclick="press('${b.t}',${b.ok})">${b.t}</button>`
 ).join("");
}

function startBar(){
 clearInterval(timer); bar=100;
 timer=setInterval(()=>{
  bar-=3; $("bar").style.width=bar+"%";
  if(bar<=0) korban("TIME");
 },120);
}
function stopBar(){clearInterval(timer);}

// ===== NETWORK =====
function send(o){
 if(mode==="single")return;
 conn.send(o);
}

function onData(o){
 if(o.type==="start") startGame();
 if(o.type==="pick") enemyPick(o.v);
 if(o.type==="stage") goto(o.v);
}

// ===== MENU =====
function menu(){
 $("menu").innerHTML=`
 <button class=btn onclick="single()">SINGLE PLAYER</button>
 <button class=btn onclick="host()">HOST GAME</button>
 <button class=btn onclick="join()">JOIN GAME</button>`;
}

function single(){mode="single";startGame();}

function host(){
 mode="host";
 peer=new Peer();

 peer.on('open',id=>{
  $("lobby").innerHTML=
  "קוד חדר:<br><b>"+id+"</b><br>ממתין לחיבור...";
 });

 peer.on('connection',c=>{
  conn=c;
  conn.on('data',onData);
  lobbyReady();
 });
}

function join(){
 mode="join";
 let id=prompt("הכנס קוד חדר");
 peer=new Peer();

 peer.on('open',()=>{
  conn=peer.connect(id);
  conn.on('open',lobbyReady);
  conn.on('data',onData);
 });
}

function lobbyReady(){
 $("lobby").innerHTML=
 `<button class=btn onclick="ready()">מוכן</button>`;
}

function ready(){
 send({type:"start"});
 startGame();
}

// ===== GAME FLOW =====
function startGame(){
 $("menu").innerHTML="";
 $("lobby").innerHTML="";

 stage=0;round=1;bal=false;
 next();
}

function press(t,ok){
 if(stage===-1){startGame();return;}

 if(!ok){korban("WRONG");return;}

 if(stage===3){
  pick(t);
  return;
 }

 if(stage===99){
  win();
  send({type:"win"});
  return;
 }

 next();
}

function next(){
 lock=false;
 const W=bal?WORD.b:WORD.n;

 switch(stage){

 case 0:
  show(W.c);buttons(d(W.c));
  startBar();stage=1;break;

 case 1:
  show(W.a);buttons(d(W.a));
  startBar();stage=2;break;

 case 2:
  show(W.ch);buttons(d(W.ch));
  startBar();stage=3;break;

 case 3:
  arena();break;

 case 4:
  show("תיקו תיקו");
  buttons(d("תיקו תיקו"));
  startBar();stage=5;break;

 case 5:
  stage=0;next();break;
 }
}

// ===== ARENA =====
function arena(){
 show("ARENA ROUND "+round);

 let opts=Object.keys(bal?BAL:ARENA);
 buttons(opts.map(x=>({t:x,ok:true})));

 startBar();
 stage=3;
}

function pick(v){
 stopBar();
 pMove=v;

 if(mode!=="single"){
  send({type:"pick",v});
 }

 if(mode==="single"){
  let opts=Object.keys(bal?BAL:ARENA);
  oMove=opts[Math.floor(Math.random()*opts.length)];
  setTimeout(resolve,600);
 }else{
  show("נבחר: "+v+"<br>ממתין ליריב...");
 }
}

function enemyPick(v){
 oMove=v;
 if(pMove)resolve();
}

function resolve(){
 let T=bal?BAL:ARENA;

 if(pMove===oMove){
  round++;

  if(round===3)bal=true;

  if(round>=4){
   sudden();return;
  }

  stage=4;next();return;
 }

 if(T[pMove]===oMove)win();
 else lose();
}

// ===== SUDDEN =====
function sudden(){
 show("SUDDEN DEATH - פטיבר עמוס");
 buttons(d("פטיבר עמוס"));
 startBar();
 stage=99;
}

// ===== END =====
function korban(r){
 stopBar();lock=true;stage=-1;
 show("<pre> KORBAN </pre>"+r);
 buttons([{t:"NEW",ok:true}]);
}

function win(){
 stopBar();lock=true;stage=-1;
 show("<pre> VICTORY </pre> DRINK!");
 buttons([{t:"AGAIN",ok:true}]);
}

function lose(){
 stopBar();lock=true;stage=-1;
 show("<pre> MAFSIDAN </pre> DRINK!");
 buttons([{t:"AGAIN",ok:true}]);
}

// ===== INIT =====
menu();
</script>
</body>
</html>
